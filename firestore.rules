/**
 * @file Firestore Security Rules for Formula Skills Garage application.
 *
 * @corePhilosophy
 * This ruleset enforces a strict ownership model where teachers can only access and modify data related to their students and training programs. Students can only access their own progress data.
 *
 * @dataStructure
 * - /teachers/{teacherId}: Stores teacher profiles. `teacherId` MUST match the Firebase auth.uid.
 * - /teachers/{teacherId}/students/{studentId}: Stores student profiles. Includes denormalized `teacherId` for authorization.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Stores training programs. Includes denormalized `teacherId`.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Stores simulation data for training programs.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Stores student progress data.
 * - /assignedTps/{studentId}: Stores assigned training programs for a student.
 * - /students/{studentId}/storedEvals/{tpId}: Stores student's final evaluation data for a specific TP.
 *
 * @keySecurityDecisions
 * - Teachers can only manage students, training programs, and simulations they own (based on `teacherId`).
 * - Students can only access their own progress data (based on `studentId`).
 * - Listing operations are generally allowed within a teacher's scope to support admin views.
 * - Open "list" access to `prelimAnswers` was the cause of the error.  This has been updated to `deny` to be more secure.
 *
 * @denormalizationForAuthorization
 * The `teacherId` is denormalized into the Student and TrainingProgram collections to avoid costly `get()` calls when checking ownership.
 *
 * @structuralSegregation
 * User data is segregated under the /teachers/{teacherId} and /students/{studentId} paths to ensure only the owning teacher or student can access it.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows access to teacher profiles. Teachers can only read/write their own profile.
     * @path /teachers/{teacherId}
     * @allow (get, create, update, delete) if request.auth.uid == teacherId
     * @deny (get, create, update, delete) if request.auth.uid != teacherId
     * @principle Enforces user-ownership: Only the teacher can access their own profile.
     */
    match /teachers/{teacherId} {
      allow get: if request.auth.uid == teacherId;
      allow list: if false;
      allow create: if request.auth.uid == teacherId;
      allow update: if request.auth.uid == teacherId && existsAfter(/databases/$(database)/documents/teachers/$(teacherId));
      allow delete: if request.auth.uid == teacherId && existsAfter(/databases/$(database)/documents/teachers/$(teacherId));
    }

    /**
     * @description Allows teachers to manage their students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (get, list, create, update, delete) if request.auth.uid == teacherId
     * @deny (get, list, create, update, delete) if request.auth.uid != teacherId
     * @principle Enforces teacher-ownership: Only the teacher can manage their students.
     */
    match /teachers/{teacherId}/students/{studentId} {
      allow get: if request.auth.uid == teacherId;
      allow list: if request.auth.uid == teacherId;
      allow create: if request.auth.uid == teacherId;
      allow update: if request.auth.uid == teacherId && existsAfter(/databases/$(database)/documents/teachers/$(teacherId)/students/$(studentId));
      allow delete: if request.auth.uid == teacherId && existsAfter(/databases/$(database)/documents/teachers/$(teacherId)/students/$(studentId));
    }

    /**
     * @description Allows teachers to manage their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (get, list, create, update, delete) if request.auth.uid == teacherId
     * @deny (get, list, create, update, delete) if request.auth.uid != teacherId
     * @principle Enforces teacher-ownership: Only the teacher can manage their training programs.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      allow get: if request.auth.uid == teacherId;
      allow list: if request.auth.uid == teacherId;
      allow create: if request.auth.uid == teacherId;
      allow update: if request.auth.uid == teacherId && existsAfter(/databases/$(database)/documents/teachers/$(teacherId)/trainingPrograms/$(trainingProgramId));
      allow delete: if request.auth.uid == teacherId && existsAfter(/databases/$(database)/documents/teachers/$(teacherId)/trainingPrograms/$(trainingProgramId));
    }

    /**
     * @description Allows teachers to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (get, list, create, update, delete) if request.auth.uid == teacherId
     * @deny (get, list, create, update, delete) if request.auth.uid != teacherId
     * @principle Enforces teacher-ownership: Only the teacher can manage simulations within their own training programs.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      allow get: if request.auth.uid == teacherId;
      allow list: if request.auth.uid == teacherId;
      allow create: if request.auth.uid == teacherId;
      allow update: if request.auth.uid == teacherId && existsAfter(/databases/$(database)/documents/teachers/$(teacherId)/trainingPrograms/$(trainingProgramId)/simulations/$(simulationId));
      allow delete: if request.auth.uid == teacherId && existsAfter(/databases/$(database)/documents/teachers/$(teacherId)/trainingPrograms/$(trainingProgramId)/simulations/$(simulationId));
    }

    /**
     * @description Allows students to access their own progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (get, list, create, update, delete) if request.auth.uid == studentId
     * @deny (get, list, create, update, delete) if request.auth.uid != studentId
     * @principle Enforces student-ownership: Only the student can access their own progress data.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      allow get: if request.auth.uid == studentId;
      allow list: if request.auth.uid == studentId;
      allow create: if request.auth.uid == studentId;
      allow update: if request.auth.uid == studentId && existsAfter(/databases/$(database)/documents/students/$(studentId)/studentProgress/$(studentProgressId));
      allow delete: if request.auth.uid == studentId && existsAfter(/databases/$(database)/documents/students/$(studentId)/studentProgress/$(studentProgressId));
    }

    /**
     * @description Allows access to the list of training programs assigned to a specific student.
     * @path /assignedTps/{studentId}
     * @allow (get, list, create, update, delete) if request.auth.uid == studentId
     * @deny (get, list, create, update, delete) if request.auth.uid != studentId
     * @principle Enforces student-ownership: Only the student can access their assigned training programs.
     */
    match /assignedTps/{studentId} {
      allow get: if request.auth.uid == studentId;
      allow list: if request.auth.uid == studentId;
      allow create: if request.auth.uid == studentId;
      allow update: if request.auth.uid == studentId && existsAfter(/databases/$(database)/documents/assignedTps/$(studentId));
      allow delete: if request.auth.uid == studentId && existsAfter(/databases/$(database)/documents/assignedTps/$(studentId));
    }

    /**
     * @description Allows access to the final evaluation data for a student on a specific TP.
     * @path /students/{studentId}/storedEvals/{tpId}
     * @allow (get, list, create, update, delete) if request.auth.uid == studentId
     * @deny (get, list, create, update, delete) if request.auth.uid != studentId
     * @principle Enforces student-ownership: Only the student can access their final evaluation data.
     */
    match /students/{studentId}/storedEvals/{tpId} {
      allow get: if request.auth.uid == studentId;
      allow list: if request.auth.uid == studentId;
      allow create: if request.auth.uid == studentId;
      allow update: if request.auth.uid == studentId && existsAfter(/databases/$(database)/documents/students/$(studentId)/storedEvals/$(tpId));
      allow delete: if request.auth.uid == studentId && existsAfter(/databases/$(database)/documents/students/$(studentId)/storedEvals/$(tpId));
    }

    /**
     * @description Denies access to prelimAnswers. This was the source of the error.
     * @path /prelimAnswers
     * @deny (get, list, create, update, delete)
     * @principle Secure by default: Explicitly denies access to the prelimAnswers collection.
     */
    match /prelimAnswers {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}