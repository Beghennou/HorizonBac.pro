/**
 * @fileoverview Firestore Security Rules for Formula Skills Garage.
 *
 * Core Philosophy: This ruleset enforces a strict user-ownership model. Teachers can only manage their own students, training programs, and simulations. Students can only access their own progress data.
 * Data Structure:
 * - /teachers/{teacherId}: Teacher profiles, where teacherId is auth.uid.
 * - /teachers/{teacherId}/students/{studentId}: Students belonging to a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Training programs created by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Simulations within a training program.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Student progress records.
 * - /students/{studentId}/storedEvals/{tpId}: Student final evaluation for a specific TP
 * Key Security Decisions:
 * - Teachers can only access resources they own (students, training programs, simulations).
 * - Students can only access their own progress data.
 * - Listing of student progress is restricted to the student.
 * - No public listing of teachers or training programs is allowed.
 * Denormalization for Authorization:  The `teacherId` is denormalized into `Student` and `TrainingProgram` documents to allow direct ownership checks without additional reads.
 * Structural Segregation:  Student progress is stored under the `/students/{studentId}` path to ensure privacy and simplify access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows teachers to manage their own profiles.
     * @path /teachers/{teacherId}
     * @allow (create) User with auth.uid 'teacher123' can create a teacher profile with id 'teacher123'.
     * @allow (get) User with auth.uid 'teacher123' can read their teacher profile (teacherId == 'teacher123').
     * @allow (update) User with auth.uid 'teacher123' can update their teacher profile (teacherId == 'teacher123').
     * @allow (delete) User with auth.uid 'teacher123' can delete their teacher profile (teacherId == 'teacher123').
     * @deny (create) User with auth.uid 'teacher456' cannot create a profile with id 'teacher123'.
     * @deny (update) User with auth.uid 'teacher456' cannot update teacher profile 'teacher123'.
     * @deny (delete) User with auth.uid 'teacher456' cannot delete teacher profile 'teacher123'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if false;
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their own students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) Teacher 'teacher123' can create a student under their profile with teacherId == 'teacher123'.
     * @allow (get) Teacher 'teacher123' can read a student under their profile.
     * @allow (update) Teacher 'teacher123' can update a student under their profile.
     * @allow (delete) Teacher 'teacher123' can delete a student under their profile.
     * @deny (create) Teacher 'teacher456' cannot create a student under teacher 'teacher123'.
     * @deny (update) Teacher 'teacher456' cannot update a student under teacher 'teacher123'.
     * @deny (delete) Teacher 'teacher456' cannot delete a student under teacher 'teacher123'.
     *  @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

       function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their own training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) Teacher 'teacher123' can create a training program under their profile with teacherId == 'teacher123'.
     * @allow (get) Teacher 'teacher123' can read a training program under their profile.
     * @allow (update) Teacher 'teacher123' can update a training program under their profile.
     * @allow (delete) Teacher 'teacher123' can delete a training program under their profile.
     * @deny (create) Teacher 'teacher456' cannot create a training program under teacher 'teacher123'.
     * @deny (update) Teacher 'teacher456' cannot update a training program under teacher 'teacher123'.
     * @deny (delete) Teacher 'teacher456' cannot delete a training program under teacher 'teacher123'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) Teacher 'teacher123' can create a simulation under their training program.
     * @allow (get) Teacher 'teacher123' can read a simulation under their training program.
     * @allow (update) Teacher 'teacher123' can update a simulation under their training program.
     * @allow (delete) Teacher 'teacher123' can delete a simulation under their training program.
     * @deny (create) Teacher 'teacher456' cannot create a simulation under teacher 'teacher123's training program.
     * @deny (update) Teacher 'teacher456' cannot update a simulation under teacher 'teacher123's training program.
     * @deny (delete) Teacher 'teacher456' cannot delete a simulation under teacher 'teacher123's training program.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows students to manage their own progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) Student 'student123' can create a progress record under their profile with studentId == 'student123'.
     * @allow (get) Student 'student123' can read their own progress record.
     * @allow (update) Student 'student123' can update their own progress record.
     * @allow (delete) Student 'student123' can delete their own progress record.
     * @deny (create) Student 'student456' cannot create a progress record under student 'student123'.
     * @deny (update) Student 'student456' cannot update student 'student123's progress record.
     * @deny (delete) Student 'student456' cannot delete student 'student123's progress record.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.studentId == resource.data.studentId;
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Allows students to store final evaluations under their profile.
     * @path /students/{studentId}/storedEvals/{tpId}
     * @allow (create) Student 'student123' can create a stored evaluation with studentId == 'student123'.
     * @allow (get) Student 'student123' can read their stored evaluation.
     * @allow (update) Student 'student123' can update their stored evaluation.
     * @allow (delete) Student 'student123' can delete their stored evaluation.
     * @deny (create) Student 'student456' cannot create a stored evaluation under student 'student123'.
     * @deny (update) Student 'student456' cannot update student 'student123's stored evaluation.
     * @deny (delete) Student 'student456' cannot delete student 'student123's stored evaluation.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /students/{studentId}/storedEvals/{tpId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.studentId == resource.data.studentId;
      allow delete: if isExistingOwner(studentId);
    }
  }
}