/**
 * @fileoverview Firestore Security Rules for the Formula Skills Garage application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model, ensuring that teachers can only manage data related to their students and training programs, and students can only access their own progress data.
 *
 * Data Structure:
 * The Firestore database is structured with the following top-level collections:
 * - /teachers/{teacherId}: Stores teacher profiles.
 * - /teachers/{teacherId}/students/{studentId}: Stores student profiles managed by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Stores training programs created by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Stores simulation data for a training program.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Stores student progress data.
 *
 * Key Security Decisions:
 * - Teachers can only manage students and training programs associated with their teacher ID.
 * - Students can only access their own progress data.
 * - Data denormalization (teacherId in Student and TrainingProgram) avoids costly `get()` calls in rules.
 * - Listing of all training programs is only allowed for the teacher.
 * - Listing of all students is only allowed for the teacher.
 * - Listing of all student progress is only allowed for the student.
 *
 * Denormalization for Authorization:
 * The 'teacherId' is denormalized into the Student and TrainingProgram documents to allow direct ownership checks without requiring additional reads.  This improves performance and simplifies the rules.
 *
 * Structural Segregation:
 * User-specific data (students, training programs, student progress) is stored under user-specific paths (/teachers/{teacherId}/..., /students/{studentId}/...) to easily enforce ownership-based access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows teachers to manage their profile.
     * @path /teachers/{teacherId}
     * @allow (get, create, update, delete) if the user is signed in and the teacherId matches the authenticated user's UID.
     * @deny (get, create, update, delete) if the user is not signed in or the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes and authenticated access for reads.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isSignedIn();
      allow list: if false;

      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (get, create, update, delete, list) if the user is signed in and the teacherId matches the authenticated user's UID.
     * @deny (get, create, update, delete, list) if the user is not signed in or the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes and authenticated access for reads.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);

      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == request.resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (get, create, update, delete, list) if the user is signed in and the teacherId matches the authenticated user's UID.
     * @deny (get, create, update, delete, list) if the user is not signed in or the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes and authenticated access for reads.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);

      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == request.resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (get, create, update, delete) if the user is signed in and the teacherId matches the authenticated user's UID.
     * @deny (get, create, update, delete) if the user is not signed in or the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes and authenticated access for reads.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);

      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows students to manage their own progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (get, create, update, delete, list) if the user is signed in and the studentId matches the authenticated user's UID.
     * @deny (get, create, update, delete, list) if the user is not signed in or the studentId does not match the authenticated user's UID.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);

      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId) && resource.data.studentId == request.resource.data.studentId;
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Denies listing all training programs at the root.
     * @path /tps
     * @deny list:  Listing training programs is not permitted at the root level.
     * @principle Listing is only allowed under a specific teacher.
     */
    match /tps {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}