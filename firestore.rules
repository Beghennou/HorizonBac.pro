/**
 * @file Firestore Security Rules for Formula Skills Garage application.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant data model where teachers own students and training programs.
 * Teachers can manage their own resources, and students can access their own progress data.
 *
 * Data Structure:
 * - /teachers/{teacherId}: Stores teacher profiles.
 * - /teachers/{teacherId}/students/{studentId}: Stores student profiles managed by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Stores training programs created by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Stores simulations within a training program.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Stores individual student progress records.
 * - /assignedTps/{studentId}: Stores assigned training programs for a student.
 * - /students/{studentId}/storedEvals/{tpId}: Stores evaluation data for a student on a specific TP.
 *
 * Key Security Decisions:
 * - Teachers can only manage students, training programs, and simulations they own.
 * - Students can only access their own progress data.
 * - Listing of all users is disallowed.
 * - All write operations require a verified user identity.
 * - The `storedEvals` collection is secured to allow both the student and the teacher to read the data.
 *
 * Denormalization for Authorization:
 * - The `teacherId` is denormalized into the `Student` and `TrainingProgram` documents to allow for
 *   efficient ownership checks without needing to perform additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to teacher profiles.
     * @path /teachers/{teacherId}
     * @allow (read) - Any signed-in user can get a teacher profile.
     * @allow (create) - A user can create their own teacher profile if the teacherId matches their auth.uid.
     * @allow (update, delete) - A teacher can update or delete their own profile.
     * @deny (create) - A user cannot create a teacher profile with an ID that doesn't match their auth.uid.
     * @deny (list) - Listing all teachers is not allowed.
     * @principle Enforces document ownership for writes and allows public reads.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if true;
      allow list: if false;
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Grants access to student profiles under a specific teacher.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (read, list) - A teacher can read and list their own students.
     * @allow (create) - A teacher can create a student under their ID. The student document must have the correct teacherId.
     * @allow (update, delete) - A teacher can update or delete their own students.
     * @deny (create) - A teacher cannot create a student with a teacherId that doesn't match their own ID.
     * @principle Enforces document ownership for writes and restricts access to a teacher's own students.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Grants access to training programs created by a specific teacher.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (read, list) - A teacher can read and list their own training programs.
     * @allow (create) - A teacher can create a training program under their ID.  The training program document must have the correct teacherId.
     * @allow (update, delete) - A teacher can update or delete their own training programs.
     * @deny (create) - A teacher cannot create a training program with a teacherId that doesn't match their own ID.
     * @principle Enforces document ownership for writes and restricts access to a teacher's own training programs.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Grants access to simulations within a specific training program.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (read, list) - A teacher can read and list their own simulations.
     * @allow (create) - A teacher can create a simulation under their training program.
     * @allow (update, delete) - A teacher can update or delete their own simulations.
     * @principle Enforces document ownership for writes and restricts access to a teacher's own simulations.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Grants access to student progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (read, list) - A student can read and list their own progress data.
     * @allow (create) - A student can create their own progress data. The studentProgress document must have the correct studentId.
     * @allow (update, delete) - A student can update or delete their own progress data.
     * @deny (create) - A student cannot create progress data with a studentId that doesn't match their own ID.
     * @principle Enforces document ownership for writes and restricts access to a student's own progress data.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Grants access to assigned training programs list.
     * @path /assignedTps/{studentId}
     * @allow (read) - A student can read their assigned training programs.
     * @allow (create, update, delete) - Not allowed.
     * @principle Restricts access to assigned training programs to only the student.
     */
    match /assignedTps/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }

      allow get: if isOwner(studentId);
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

     /**
     * @description Accès aux documents d'évaluation stockés pour un élève spécifique.
     * @path /students/{studentId}/storedEvals/{tpId}
     * @allow (read) - L'élève concerné peut lire ses propres évaluations.
     * @allow (read) - L'enseignant propriétaire de cet élève peut lire ses évaluations.
     * @principle Accès en lecture partagé entre l'élève et son enseignant désigné.
     */
    match /students/{studentId}/storedEvals/{tpId} {
      function isSignedIn() {
        return request.auth != null;
      }

      // Nouvelle fonction d'aide pour vérifier si l'utilisateur authentifié est l'enseignant de cet élève
      function isTeacherOfThisStudent(studentId) {
        // Assurez-vous que le document étudiant à la racine /students/{studentId} contient un champ 'teacherId'
        // et que l'UID de l'utilisateur authentifié correspond à ce teacherId.
        return isSignedIn() && request.auth.uid == get(/databases/$(database)/documents/teachers/$(studentId)).data.id;
      }
      allow read: if isSignedIn() && (
        request.auth.uid == studentId || // L'utilisateur est l'élève concerné
        isTeacherOfThisStudent(studentId) // L'utilisateur est l'enseignant de cet élève
      );
      allow create: if false;
      allow update: if false;
      allow delete: if false;
      allow list: if false;
    }
  }
}