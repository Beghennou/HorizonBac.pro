/**
 * @file Overview
 * This ruleset enforces a strict, path-based ownership model.
 * All data is nested under /teachers/{teacherId} or /students/{studentId}, reflecting a clear ownership hierarchy.
 *
 * Data Structure:
 * - /teachers/{teacherId}: Teacher profiles, where {teacherId} MUST match the authenticated user's UID.
 * - /teachers/{teacherId}/students/{studentId}: Student profiles owned by the teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Training programs created by the teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Simulations within a training program.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Student's progress records.
 *
 * Key Security Decisions:
 * - Teachers can only manage students, training programs, and simulations that they own (i.e., where the teacherId matches their UID).
 * - Students can only manage their own progress records.
 * - Listing of all teachers is disallowed.
 * - Data consistency between the path and document data is enforced on create and update operations to prevent unauthorized access or data manipulation.
 *
 * Denormalization for Authorization:
 * - The `teacherId` field is denormalized into the `Student` and `TrainingProgram` entities. This allows for direct ownership checks without needing to perform additional `get()` operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows teachers to manage their own profiles.
     * @path /teachers/{teacherId}
     * @allow (create, update, delete) if the teacherId matches the authenticated user's UID.
     * @allow (get) if the teacherId matches the authenticated user's UID.
     * @deny (list) because listing all teachers is not permitted.
     * @deny (create, update, delete) if the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if false;
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) if the teacherId matches the authenticated user's UID and the student's teacherId also matches.
     * @allow (update, delete) if the teacherId matches the authenticated user's UID and the student exists.
     * @allow (get, list) if the teacherId matches the authenticated user's UID.
     * @deny (create, update, delete) if the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == request.resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) if the teacherId matches the authenticated user's UID and the training program's teacherId also matches.
     * @allow (update, delete) if the teacherId matches the authenticated user's UID and the training program exists.
     * @allow (get, list) if the teacherId matches the authenticated user's UID.
     * @deny (create, update, delete) if the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == request.resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create, update, delete) if the teacherId matches the authenticated user's UID and the training program exists.
     * @allow (get, list) if the teacherId matches the authenticated user's UID.
     * @deny (create, update, delete) if the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows students to manage their own progress records.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) if the studentId matches the authenticated user's UID and the progress record's studentId also matches.
     * @allow (update, delete) if the studentId matches the authenticated user's UID and the progress record exists.
     * @allow (get, list) if the studentId matches the authenticated user's UID.
     * @deny (create, update, delete) if the studentId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }

       function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId) && resource.data.studentId == request.resource.data.studentId;
      allow delete: if isExistingOwner(studentId);
    }
    
    /**
     * @description Placeholder for resolving the permission error on /prelimAnswers.
     * @path /prelimAnswers
     * @allow get, list: if false; // TODO: Add proper authorization logic. Currently denying all access.
     * @allow create, update, delete: if false;
     */
    match /prelimAnswers {
        allow get, list: if false; // TODO: Add proper authorization logic. Currently denying all access.
        allow create, update, delete: if false;
    }
  }
}