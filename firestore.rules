/**
 * @file Firestore Security Rules for Formula Skills Garage.
 *
 * Core Philosophy:
 * This ruleset enforces a strict ownership model, primarily based on path-based authorization,
 * where teachers can only manage data directly associated with their own user ID. Students
 * can only manage their own progress records.
 *
 * Data Structure:
 * - /teachers/{teacherId}: Teacher profiles, where {teacherId} must match the authenticated user's UID.
 * - /teachers/{teacherId}/students/{studentId}: Student profiles managed by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Training programs created by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Simulations within a training program.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Student progress records.
 *
 * Key Security Decisions:
 * - Teachers can only access students, training programs, and simulations associated with their teacher ID.
 * - Students can only access their own progress records.
 * - Listing of teachers is disallowed.
 * - The 'id' field in each document at the root level of a user path is explicitly validated against the path parameter to prevent ID spoofing.
 * - Data shape validation is minimized for prototyping, focusing on relational integrity and authorization.
 *
 * Denormalization for Authorization:
 * - The `teacherId` field is denormalized in the `Student` and `TrainingProgram` entities to allow for direct authorization checks without requiring additional `get()` calls.
 *
 * Structural Segregation:
 * - StudentProgress data is stored under the student's path (`/students/{studentId}/studentProgress/{studentProgressId}`).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description: Allows teachers to manage their own profile data.
     * @path: /teachers/{teacherId}
     * @allow: User with UID 'teacher123' can create/update/get their own profile at /teachers/teacher123 when authenticated. (create, update, get)
     * @deny: User with UID 'teacher456' cannot create/update/get profile at /teachers/teacher123. (create, update, get)
     * @principle: Enforces document ownership for writes and reads.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if false; // Listing teachers is not permitted.
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description: Allows teachers to manage students associated with their teacher ID.
     * @path: /teachers/{teacherId}/students/{studentId}
     * @allow: Teacher 'teacher123' can create/update/get student 'student456' under /teachers/teacher123/students/student456 if authenticated. (create, update, get)
     * @deny: Teacher 'teacher456' cannot create/update/get student 'student456' under /teachers/teacher123/students/student456. (create, update, get)
     * @principle: Enforces path-based ownership for writes and reads.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description: Allows teachers to manage training programs associated with their teacher ID.
     * @path: /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow: Teacher 'teacher123' can create/update/get training program 'tp1' under /teachers/teacher123/trainingPrograms/tp1 if authenticated. (create, update, get)
     * @deny: Teacher 'teacher456' cannot create/update/get training program 'tp1' under /teachers/teacher123/trainingPrograms/tp1. (create, update, get)
     * @principle: Enforces path-based ownership for writes and reads.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description: Allows teachers to manage simulations within training programs associated with their teacher ID.
     * @path: /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow: Teacher 'teacher123' can create/update/get simulation 'sim1' under /teachers/teacher123/trainingPrograms/tp1/simulations/sim1 if authenticated. (create, update, get)
     * @deny: Teacher 'teacher456' cannot create/update/get simulation 'sim1' under /teachers/teacher123/trainingPrograms/tp1/simulations/sim1. (create, update, get)
     * @principle: Enforces path-based ownership for writes and reads.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description: Allows students to manage their own progress records.
     * @path: /students/{studentId}/studentProgress/{studentProgressId}
     * @allow: Student 'student123' can create/update/get their own progress record 'progress1' under /students/student123/studentProgress/progress1 if authenticated. (create, update, get)
     * @deny: Student 'student456' cannot create/update/get progress record 'progress1' under /students/student123/studentProgress/progress1. (create, update, get)
     * @principle: Enforces path-based ownership for writes and reads.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }
  }
}