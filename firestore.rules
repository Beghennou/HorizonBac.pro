/**
 * @file Firestore Security Rules for Formula Skills Garage Application
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for teachers and students, ensuring data privacy and access control.
 * Teachers can only manage data related to their own students and training programs. Students can only access their own progress data.
 *
 * @data_structure The Firestore database is structured with nested collections to represent the relationships between teachers, students, training programs, and simulations.
 * All data is nested under either /teachers/{teacherId} or /students/{studentId}, where the IDs match the Firebase auth.uid of the respective user.
 *
 * @key_security_decisions
 * - **No User Listing**: Listing all teachers or students is explicitly denied to prevent unauthorized access to user data.
 * - **Ownership Validation**: All write operations are validated against the authenticated user's UID to ensure they own the data they are modifying.
 * - **Data Denormalization**: The `teacherId` is denormalized into the `Student` and `TrainingProgram` documents to allow for authorization without additional `get()` calls.
 * - **Student Progress**: Students can only read/write their progress within their own student ID.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if the authenticated user is the owner of the document (teacher or student).
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check if the authenticated user is the existing owner of the document.
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Allows teachers to manage their own profiles.
     * @path /teachers/{teacherId}
     * @allow (create) User with UID 'teacher123' can create a teacher document with teacherId: 'teacher123'.
     * @deny (create) User with UID 'student456' cannot create a teacher document.
     * @principle Enforces document ownership for writes.
     */
    match /teachers/{teacherId} {
      allow get: if isOwner(teacherId);
      allow list: if false;
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) Teacher with UID 'teacher123' can create a student document under /teachers/teacher123/students/student456.
     * @deny (create) Teacher with UID 'teacher123' cannot create a student document under /teachers/teacher456/students/student456.
     * @principle Restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/students/{studentId} {
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) Teacher with UID 'teacher123' can create a training program document under /teachers/teacher123/trainingPrograms/tp123.
     * @deny (create) Teacher with UID 'teacher123' cannot create a training program document under /teachers/teacher456/trainingPrograms/tp123.
     * @principle Restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) Teacher with UID 'teacher123' can create a simulation document under /teachers/teacher123/trainingPrograms/tp123/simulations/sim123.
     * @deny (create) Teacher with UID 'teacher123' cannot create a simulation document under /teachers/teacher456/trainingPrograms/tp123/simulations/sim123.
     * @principle Restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows students to manage their own progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) Student with UID 'student123' can create a student progress document under /students/student123/studentProgress/sp123.
     * @deny (create) Student with UID 'student123' cannot create a student progress document under /students/student456/studentProgress/sp123.
     * @principle Restricts access to a user's own data tree.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId) && resource.data.studentId == studentId;
      allow delete: if isExistingOwner(studentId);
    }

      /**
       * @description Allows to store a list of training programs assigned to a specific student.
       * @path /assignedTps/{studentId}
       * @allow (create) Authenticated user can create a document with their student ID.
       * @deny (create) Authenticated user cannot create a document with someone else's student ID.
       *
       */
    match /assignedTps/{studentId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows students to manage their stored evaluations.
     * @path /students/{studentId}/storedEvals/{tpId}
     * @allow (create) Student with UID 'student123' can create an evaluation document under /students/student123/storedEvals/tp123.
     * @deny (create) Student with UID 'student123' cannot create an evaluation document under /students/student456/storedEvals/tp123.
     * @principle Restricts access to a user's own data tree.
     */
    match /students/{studentId}/storedEvals/{tpId} {
          allow get: if isOwner(studentId);
          allow list: if isOwner(studentId);
          allow create: if isOwner(studentId);
          allow update: if isExistingOwner(studentId);
          allow delete: if isExistingOwner(studentId);
    }
  }
}