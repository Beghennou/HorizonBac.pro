/**
 * @fileoverview Firestore Security Rules for the Formula Skills Garage application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model, primarily based on the `teacherId` and `studentId` fields, ensuring that users can only access and modify data they own or are explicitly associated with.
 *
 * Data Structure:
 * - /teachers/{teacherId}: Stores teacher profiles. `teacherId` MUST match the authenticated user's UID.
 * - /teachers/{teacherId}/students/{studentId}: Stores student profiles associated with a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Stores training programs created by teachers.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Stores simulation data for training programs.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Stores student progress data.
 * - /students/{studentId}/storedEvals/{tpId}: Stores the final evaluation data for a student on a specific TP
 *
 * Key Security Decisions:
 * - Teachers can only access/modify Students and TrainingPrograms they are responsible for (enforced via `teacherId`).
 * - Students can only access/modify their own progress data (enforced via `studentId`).
 * - Data consistency is enforced between document IDs and `teacherId`/`studentId` fields.
 * - Listing of collections is generally restricted to owners (e.g., teachers listing their students).
 *
 * Denormalization for Authorization:
 * - The `teacherId` is denormalized into the Student and TrainingProgram documents to simplify authorization checks and avoid costly `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows read and write access to teacher profiles, but only if the teacherId matches the authenticated user's UID.
     * @path /teachers/{teacherId}
     * @allow (create, update, delete) if request.auth.uid == teacherId
     * @allow (get, list) if request.auth.uid == teacherId
     * @deny (create, update, delete) if request.auth.uid != teacherId
     * @deny (get, list) if request.auth.uid != teacherId
     * @principle Enforces document ownership for all operations on teacher profiles.
     */
    match /teachers/{teacherId} {
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if false;

      allow create: if isOwner(teacherId);
      allow update: if isOwner(teacherId) && resource != null;
      allow delete: if isOwner(teacherId) && resource != null;
    }

    /**
     * @description Allows a teacher to manage students associated with their profile.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) if request.auth.uid == teacherId && request.resource.data.teacherId == teacherId
     * @allow (get, list, update, delete) if request.auth.uid == teacherId && resource.data.teacherId == teacherId
     * @deny (create) if request.auth.uid != teacherId || request.resource.data.teacherId != teacherId
     * @deny (get, list, update, delete) if request.auth.uid != teacherId || resource.data.teacherId != teacherId
     * @principle Enforces teacher ownership of student profiles.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);

      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
      allow delete: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
    }

    /**
     * @description Allows a teacher to manage training programs they created.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) if request.auth.uid == teacherId && request.resource.data.teacherId == teacherId
     * @allow (get, list, update, delete) if request.auth.uid == teacherId && resource.data.teacherId == teacherId
     * @deny (create) if request.auth.uid != teacherId || request.resource.data.teacherId != teacherId
     * @deny (get, list, update, delete) if request.auth.uid != teacherId || resource.data.teacherId != teacherId
     * @principle Enforces teacher ownership of training programs.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);

      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
      allow delete: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
    }

    /**
     * @description Allows a teacher to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) if request.auth.uid == teacherId
     * @allow (get, list, update, delete) if request.auth.uid == teacherId
     * @deny (create, update, delete) if request.auth.uid != teacherId
     * @deny (get, list) if request.auth.uid != teacherId
     * @principle Enforces teacher ownership of simulations.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);

      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows a student to manage their own progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) if request.auth.uid == studentId && request.resource.data.studentId == studentId
     * @allow (get, list, update, delete) if request.auth.uid == studentId && resource.data.studentId == studentId
     * @deny (create) if request.auth.uid != studentId || request.resource.data.studentId != studentId
     * @deny (get, list, update, delete) if request.auth.uid != studentId || resource.data.studentId != studentId
     * @principle Enforces student ownership of progress data.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }
      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);

      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId) && resource.data.studentId == studentId;
      allow delete: if isExistingOwner(studentId) && resource.data.studentId == studentId;
    }
    /**
     * @description Allows a student to manage their own stored evaluations.
     * @path /students/{studentId}/storedEvals/{tpId}
     * @allow (create) if request.auth.uid == studentId
     * @allow (get, list, update, delete) if request.auth.uid == studentId
     * @deny (create, update, delete) if request.auth.uid != studentId
     * @deny (get, list) if request.auth.uid != studentId
     * @principle Enforces student ownership of stored evaluations.
     */
        match /students/{studentId}/storedEvals/{tpId} {
          function isOwner(studentId) {
            return request.auth.uid == studentId;
          }
          function isExistingOwner(studentId) {
            return isOwner(studentId) && resource != null;
          }
          function isSignedIn() {
            return request.auth != null;
          }

          allow get: if isOwner(studentId);
          allow list: if isOwner(studentId);

          allow create: if isOwner(studentId);
          allow update: if isExistingOwner(studentId);
          allow delete: if isExistingOwner(studentId);
    }
    
        /**
         * @description  Denies all access to the /classes collection as per issue #1.
         * @path /classes
         * @allow NONE
         * @principle Hard deny of the /classes collection.
         */
    match /classes {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}