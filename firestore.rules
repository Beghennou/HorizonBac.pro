/**
 * @file Firebase Security Rules for Formula Skills Garage application.
 *
 * @Core Philosophy:
 * This ruleset enforces a strict user-ownership model, ensuring that users (teachers and students) can only access and modify data that they own or that has been explicitly shared with them.
 * Path-based authorization and data denormalization are used to improve security and performance.
 *
 * @Data Structure:
 * - /teachers/{teacherId}: Stores teacher profiles. The teacherId must match the Firebase auth.uid.
 * - /teachers/{teacherId}/students/{studentId}: Stores student profiles managed by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Stores training programs created by teachers.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Stores simulation data associated with training programs.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Stores student progress data.
 * - /students/{studentId}/storedEvals/{tpId}: Stores final evaluation data for a student on a specific TP.
 *
 * @Key Security Decisions:
 * - Teachers can only manage students and training programs they own.
 * - Students can only access their own progress data.
 * - Data denormalization is used to avoid costly `get()` calls in security rules.
 * - List operations are generally allowed within a user's own data tree but are restricted elsewhere.
 *
 * @Denormalization for Authorization:
 * - The `teacherId` is denormalized into the `Student` and `TrainingProgram` documents to allow direct authorization checks without additional reads.
 *
 * @Structural Segregation:
 * - Private data is stored under user-specific paths (e.g., /teachers/{teacherId}/...) to ensure that only the owner can access it.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a teacher to read and write their own profile.
     * @path /teachers/{teacherId}
     * @allow (get, create, update, delete) if the teacher's auth.uid matches the teacherId.
     * @deny (get, create, update, delete) if the teacher's auth.uid does not match the teacherId.
     * @principle Enforces document ownership: Only the teacher can manage their own profile.
     */
    match /teachers/{teacherId} {
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
      allow get: if isOwner(teacherId);
      allow list: if false;
      allow create: if isOwner(teacherId);
      allow update: if isOwner(teacherId) && resource != null;
      allow delete: if isOwner(teacherId) && resource != null;
    }

    /**
     * @description Allows a teacher to manage their students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (get, list, create, update, delete) if the teacher's auth.uid matches the teacherId.
     * @deny (get, list, create, update, delete) if the teacher's auth.uid does not match the teacherId.
     * @principle Enforces document ownership: Only the teacher can manage their own students.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isOwner(teacherId) && resource != null;
      allow delete: if isOwner(teacherId) && resource != null;
    }

    /**
     * @description Allows a teacher to manage their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (get, list, create, update, delete) if the teacher's auth.uid matches the teacherId.
     * @deny (get, list, create, update, delete) if the teacher's auth.uid does not match the teacherId.
     * @principle Enforces document ownership: Only the teacher can manage their own training programs.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isOwner(teacherId) && resource != null;
      allow delete: if isOwner(teacherId) && resource != null;
    }

    /**
     * @description Allows a teacher to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (get, list, create, update, delete) if the teacher's auth.uid matches the teacherId.
     * @deny (get, list, create, update, delete) if the teacher's auth.uid does not match the teacherId.
     * @principle Enforces document ownership: Only the teacher can manage simulations within their own training programs.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isOwner(teacherId) && resource != null;
      allow delete: if isOwner(teacherId) && resource != null;
    }

    /**
     * @description Allows a student to read and write their own progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (get, list, create, update, delete) if the student's auth.uid matches the studentId.
     * @deny (get, list, create, update, delete) if the student's auth.uid does not match the studentId.
     * @principle Enforces document ownership: Only the student can manage their own progress data.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }
      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isOwner(studentId) && resource != null;
      allow delete: if isOwner(studentId) && resource != null;
    }

       /**
        * @description Allows a student to read and write their own stored evaluation data.
        * @path /students/{studentId}/storedEvals/{tpId}
        * @allow (get, list, create, update, delete) if the student's auth.uid matches the studentId.
        * @deny (get, list, create, update, delete) if the student's auth.uid does not match the studentId.
        * @principle Enforces document ownership: Only the student can manage their own stored evaluation data.
        */
    match /students/{studentId}/storedEvals/{tpId} {
      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }
      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isOwner(studentId) && resource != null;
      allow delete: if isOwner(studentId) && resource != null;
    }

    /**
     * @description Allows a student to only read list of Assigned Training Programs.
     * @path /assignedTps/{studentId}
     * @allow (get, list) if the student's auth.uid matches the studentId.
     * @deny (create, update, delete) all operations, only read is allowed
     * @principle Enforces document ownership: Only the student can view a list of the Assigned TPs
     */
    match /assignedTps/{studentId} {
      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }
      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}