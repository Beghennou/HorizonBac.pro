/**
 * @fileoverview Firestore Security Rules for Formula Skills Garage.
 *
 * Core Philosophy: This ruleset enforces a strict user-ownership model,
 * where teachers have full control over their own data (Training Programs, Students)
 * and students can only access their own progress data. Data consistency
 * between document IDs and internal fields is enforced to prevent data leaks
 * or unauthorized access.
 *
 * Data Structure:
 * - /teachers/{teacherId}: Teacher profiles, where teacherId is the Firebase auth.uid.
 * - /teachers/{teacherId}/students/{studentId}: Student profiles managed by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Training programs created by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Simulations within a training program.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Student's progress records.
 *
 * Key Security Decisions:
 * - Teachers can only manage resources (students, training programs, simulations) under their own teacherId.
 * - Students can only access their own progress records.
 * - Listing of all users is disallowed to prevent information leaks.
 *
 * Denormalization for Authorization:
 * - The `teacherId` is denormalized into the Student and TrainingProgram documents to
 *   allow direct ownership checks without additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows teachers to manage their own profile.
     * @path /teachers/{teacherId}
     * @allow (create) If the user is signed in and the teacherId matches their UID.
     * @deny (create) If the user is not signed in or the teacherId does not match their UID.
     * @allow (get) If the teacherId matches the authenticated user's UID.
     * @deny (get) If the teacherId does not match the authenticated user's UID.
     * @allow (update) If the teacherId matches the authenticated user's UID and the ID hasn't been changed.
     * @deny (update) If the teacherId does not match the authenticated user's UID or the ID has been changed.
     * @allow (delete) If the teacherId matches the authenticated user's UID.
     * @deny (delete) If the teacherId does not match the authenticated user's UID.
     * @allow (list) Listing teachers is not allowed.
     * @principle Enforces document ownership and prevents unauthorized profile access.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }
      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }
      allow get: if isOwner(teacherId);
      allow list: if false;
      allow create: if isOwner(teacherId) && request.resource.data.id == request.auth.uid;
      allow update: if isExistingOwner(teacherId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) If the teacherId matches the authenticated user's UID and the student's teacherId matches the path.
     * @deny (create) If the teacherId does not match the authenticated user's UID or the student's teacherId does not match the path.
     * @allow (get) If the teacherId matches the authenticated user's UID.
     * @deny (get) If the teacherId does not match the authenticated user's UID.
     * @allow (update) If the teacherId matches the authenticated user's UID and the student's teacherId has not been changed.
     * @deny (update) If the teacherId does not match the authenticated user's UID or the student's teacherId has been changed.
     * @allow (delete) If the teacherId matches the authenticated user's UID.
     * @deny (delete) If the teacherId does not match the authenticated user's UID.
     * @allow (list) If the teacherId matches the authenticated user's UID.
     * @deny (list) If the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership and prevents unauthorized student management.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }
        function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) If the teacherId matches the authenticated user's UID and the training program's teacherId matches the path.
     * @deny (create) If the teacherId does not match the authenticated user's UID or the training program's teacherId does not match the path.
     * @allow (get) If the teacherId matches the authenticated user's UID.
     * @deny (get) If the teacherId does not match the authenticated user's UID.
     * @allow (update) If the teacherId matches the authenticated user's UID and the training program's teacherId has not been changed.
     * @deny (update) If the teacherId does not match the authenticated user's UID or the training program's teacherId has been changed.
     * @allow (delete) If the teacherId matches the authenticated user's UID.
     * @deny (delete) If the teacherId does not match the authenticated user's UID.
     * @allow (list) If the teacherId matches the authenticated user's UID.
     * @deny (list) If the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership and prevents unauthorized training program management.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }
        function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) If the teacherId matches the authenticated user's UID.
     * @deny (create) If the teacherId does not match the authenticated user's UID.
     * @allow (get) If the teacherId matches the authenticated user's UID.
     * @deny (get) If the teacherId does not match the authenticated user's UID.
     * @allow (update) If the teacherId matches the authenticated user's UID.
     * @deny (update) If the teacherId does not match the authenticated user's UID.
     * @allow (delete) If the teacherId matches the authenticated user's UID.
     * @deny (delete) If the teacherId does not match the authenticated user's UID.
     * @allow (list) If the teacherId matches the authenticated user's UID.
     * @deny (list) If the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership and prevents unauthorized simulation management.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }
        function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows students to manage their own progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) If the studentId matches the authenticated user's UID.
     * @deny (create) If the studentId does not match the authenticated user's UID.
     * @allow (get) If the studentId matches the authenticated user's UID.
     * @deny (get) If the studentId does not match the authenticated user's UID.
     * @allow (update) If the studentId matches the authenticated user's UID.
     * @deny (update) If the studentId does not match the authenticated user's UID.
     * @allow (delete) If the studentId matches the authenticated user's UID.
     * @deny (delete) If the studentId does not match the authenticated user's UID.
     * @allow (list) If the studentId matches the authenticated user's UID.
     * @deny (list) If the studentId does not match the authenticated user's UID.
     * @principle Enforces document ownership and prevents unauthorized access to progress data.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }
        function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }
      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.studentId == resource.data.studentId;
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Allows students to store evaluation data.
     * @path /students/{studentId}/storedEvals/{tpId}
     * @allow (create) If the studentId matches the authenticated user's UID.
     * @deny (create) If the studentId does not match the authenticated user's UID.
     * @allow (get) If the studentId matches the authenticated user's UID.
     * @deny (get) If the studentId does not match the authenticated user's UID.
     * @allow (update) If the studentId matches the authenticated user's UID.
     * @deny (update) If the studentId does not match the authenticated user's UID.
     * @allow (delete) If the studentId matches the authenticated user's UID.
     * @deny (delete) If the studentId does not match the authenticated user's UID.
     *  @allow (list) If the studentId matches the authenticated user's UID.
     * @deny (list) If the studentId does not match the authenticated user's UID.
     * @principle Enforces document ownership and prevents unauthorized access to evaluation data.
     */
    match /students/{studentId}/storedEvals/{tpId} {
        function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }
        function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }
      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }
  }
}