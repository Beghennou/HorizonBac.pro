/**
 * @fileOverview
 * This ruleset enforces a strict user-ownership model for the Formula Skills Garage application.
 * All data is nested under user-specific paths, primarily `/teachers/{teacherId}` and `/students/{studentId}`,
 * where `teacherId` and `studentId` correspond to the Firebase `auth.uid`.
 *
 * Data Structure:
 * - `/teachers/{teacherId}`: Stores teacher profiles, accessible only by the teacher themselves.
 * - `/teachers/{teacherId}/students/{studentId}`: Stores student profiles, accessible only by the teacher who owns them.
 * - `/teachers/{teacherId}/trainingPrograms/{trainingProgramId}`: Stores training programs, accessible only by the teacher who created them.
 * - `/teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}`: Stores simulation data, accessible only by the teacher who owns the parent training program.
 * - `/students/{studentId}/studentProgress/{studentProgressId}`: Stores student progress, accessible only by the student themselves.
 *
 * Key Security Decisions:
 * - Teachers can only manage data directly related to themselves (students, training programs, simulations).
 * - Students can only manage their own progress data.
 * - Listing of teacher documents is disallowed.
 * - Listing of student documents is allowed for the parent teacher.
 *
 * Denormalization for Authorization:
 * - The `teacherId` is denormalized into the `Student` and `TrainingProgram` documents to allow for simple ownership checks without additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects teacher profiles, ensuring only the authenticated user can manage their own profile.
     * @path /teachers/{teacherId}
     * @allow (create, update, delete) - User with matching auth.uid creates, updates, or deletes their own profile.
     *   Example: `auth.uid: "teacher123", request.resource.data.id: "teacher123"`
     * @deny (create, update, delete) - User attempts to create, update, or delete a profile with a mismatched teacherId.
     *   Example: `auth.uid: "teacher456", request.resource.data.id: "teacher123"`
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /teachers/{teacherId} {
      // Only allow authenticated users to access teacher data
      allow get: if isSignedIn();
      allow list: if false;

      // Teachers can only create their own profile, and the teacherId must match the authenticated user's uid
      allow create: if isSignedIn() && request.auth.uid == teacherId;

      // Teachers can only update their own profile, and the teacherId in the document must match the authenticated user's uid
      allow update: if isSignedIn() && isExistingOwner(teacherId) && request.auth.uid == teacherId;

      // Teachers can only delete their own profile, and the teacherId in the document must match the authenticated user's uid
      allow delete: if isSignedIn() && isExistingOwner(teacherId) && request.auth.uid == teacherId;
    }

    /**
     * @description Protects student profiles, ensuring only the owning teacher can manage them.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create, update, delete) - Teacher with matching teacherId creates, updates, or deletes a student profile.
     *   Example: `auth.uid: "teacher123", resource.data.teacherId: "teacher123"`
     * @deny (create, update, delete) - User attempts to create, update, or delete a student profile with a mismatched teacherId.
     *   Example: `auth.uid: "teacher456", resource.data.teacherId: "teacher123"`
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/students/{studentId} {
      // Only allow authenticated users to access student data
      allow get: if isSignedIn() && isOwner(teacherId);
      allow list: if isSignedIn() && isOwner(teacherId);

      // Teachers can only create students for themselves
      allow create: if isSignedIn() && isOwner(teacherId) && request.resource.data.teacherId == teacherId;

      // Teachers can only update students that belong to them, and the teacherId must not be changed.
      allow update: if isSignedIn() && isExistingOwner(teacherId) && resource.data.teacherId == teacherId && request.resource.data.teacherId == resource.data.teacherId;

      // Teachers can only delete students that belong to them
      allow delete: if isSignedIn() && isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
    }

    /**
     * @description Protects training programs, ensuring only the owning teacher can manage them.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create, update, delete) - Teacher with matching teacherId creates, updates, or deletes a training program.
     *   Example: `auth.uid: "teacher123", resource.data.teacherId: "teacher123"`
     * @deny (create, update, delete) - User attempts to create, update, or delete a training program with a mismatched teacherId.
     *   Example: `auth.uid: "teacher456", resource.data.teacherId: "teacher123"`
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      // Only allow authenticated users to access training program data
      allow get: if isSignedIn() && isOwner(teacherId);
      allow list: if isSignedIn() && isOwner(teacherId);

      // Teachers can only create training programs for themselves
      allow create: if isSignedIn() && isOwner(teacherId) && request.resource.data.teacherId == teacherId;

      // Teachers can only update training programs that belong to them, and the teacherId must not be changed.
      allow update: if isSignedIn() && isExistingOwner(teacherId) && resource.data.teacherId == teacherId && request.resource.data.teacherId == resource.data.teacherId;

      // Teachers can only delete training programs that belong to them
      allow delete: if isSignedIn() && isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
    }

    /**
     * @description Protects simulations, ensuring only the owning teacher (via the training program) can manage them.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create, update, delete) - Teacher with matching teacherId creates, updates, or deletes a simulation within their training program.
     *   Example: `auth.uid: "teacher123", get(/databases/$(database)/documents/teachers/teacher123/trainingPrograms/tp123").data.teacherId == "teacher123"`
     * @deny (create, update, delete) - User attempts to create, update, or delete a simulation with a mismatched teacherId or trainingProgramId.
     *   Example: `auth.uid: "teacher456", get(/databases/$(database)/documents/teachers/teacher123/trainingPrograms/tp123").data.teacherId == "teacher123"`
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree, using a get() call to check the parent document.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      // Only allow authenticated users to access simulation data
      allow get: if isSignedIn() && isOwner(teacherId);
      allow list: if isSignedIn() && isOwner(teacherId);

      // Teachers can only create simulations for training programs that belong to them
      allow create: if isSignedIn() && isOwner(teacherId) && get(/databases/$(database)/documents/teachers/$(teacherId)/trainingPrograms/$(trainingProgramId)).data.teacherId == teacherId;

      // Teachers can only update simulations that belong to them
      allow update: if isSignedIn() && isExistingOwner(teacherId) && get(/databases/$(database)/documents/teachers/$(teacherId)/trainingPrograms/$(trainingProgramId)).data.teacherId == teacherId;

      // Teachers can only delete simulations that belong to them
      allow delete: if isSignedIn() && isExistingOwner(teacherId) && get(/databases/$(database)/documents/teachers/$(teacherId)/trainingPrograms/$(trainingProgramId)).data.teacherId == teacherId;
    }

    /**
     * @description Protects student progress data, ensuring only the student themselves can manage their own progress.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create, update, delete) - User with matching auth.uid creates, updates, or deletes their own progress data.
     *   Example: `auth.uid: "student123", resource.data.studentId: "student123"`
     * @deny (create, update, delete) - User attempts to create, update, or delete progress data with a mismatched studentId.
     *   Example: `auth.uid: "student456", resource.data.studentId: "student123"`
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      // Only allow authenticated users to access student progress data
      allow get: if isSignedIn() && isOwner(studentId);
      allow list: if isSignedIn() && isOwner(studentId);

      // Students can only create progress records for themselves
      allow create: if isSignedIn() && isOwner(studentId) && request.resource.data.studentId == studentId;

      // Students can only update progress records that belong to them, and the studentId must not be changed.
      allow update: if isSignedIn() && isExistingOwner(studentId) && resource.data.studentId == studentId && request.resource.data.studentId == resource.data.studentId;

      // Students can only delete progress records that belong to them
      allow delete: if isSignedIn() && isExistingOwner(studentId) && resource.data.studentId == studentId;
    }

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }
  }
}