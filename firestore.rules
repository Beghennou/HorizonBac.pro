/**
 * @file Firestore Security Rules for Formula Skills Garage application.
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model, primarily based on path-based authorization.
 *  Teachers can only manage data directly under their /teachers/{teacherId} path, and students can only manage
 *  data under their /students/{studentId} path. Denormalization is used to avoid costly `get()` calls,
 *  with `teacherId` stored on `Student` and `TrainingProgram` documents.
 * @data_structure
 *  - /teachers/{teacherId}: Teacher profiles, where teacherId matches auth.uid.
 *  - /teachers/{teacherId}/students/{studentId}: Student profiles managed by a teacher.
 *  - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Training programs created by a teacher.
 *  - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Simulations related to a training program.
 *  - /students/{studentId}/studentProgress/{studentProgressId}: Student progress records.
 * @key_security_decisions
 *  - Teacher and Student listing is restricted to their own data scopes.
 *  - Data validation is limited to authorization and relational integrity checks for rapid prototyping.
 * @denormalization_for_authorization `teacherId` is denormalized into the Student and TrainingProgram collections to avoid costly `get()` calls.
 * @structural_segregation User-specific data is stored under the /teachers/{teacherId} and /students/{studentId} paths.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows teachers to manage their own profiles.
     * @path /teachers/{teacherId}
     * @allow (create) If the user is authenticated and the teacherId matches the authenticated user's UID.
     * @allow (get) If the teacherId matches the authenticated user's UID.
     * @allow (update) If the teacherId matches the authenticated user's UID and the document exists.
     * @allow (delete) If the teacherId matches the authenticated user's UID and the document exists.
     * @deny (create) If the teacherId does not match the authenticated user's UID.
     * @deny (update) If the teacherId does not match the authenticated user's UID.
     * @deny (delete) If the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
          return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if false; // Teachers should not be able to list all teachers.
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage students under their profile.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) If the user is authenticated, the teacherId matches the authenticated user's UID, and the teacherId in the request data matches the path.
     * @allow (get) If the teacherId matches the authenticated user's UID.
     * @allow (list) If the teacherId matches the authenticated user's UID.
     * @allow (update) If the teacherId matches the authenticated user's UID, the document exists, and the teacherId in the request data matches the existing document.
     * @allow (delete) If the teacherId matches the authenticated user's UID and the document exists.
     * @deny (create) If the teacherId does not match the authenticated user's UID.
     * @deny (update) If the teacherId does not match the authenticated user's UID.
     * @deny (delete) If the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree, validates relational integrity between documents.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage training programs under their profile.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) If the user is authenticated, the teacherId matches the authenticated user's UID, and the teacherId in the request data matches the path.
     * @allow (get) If the teacherId matches the authenticated user's UID.
     * @allow (list) If the teacherId matches the authenticated user's UID.
     * @allow (update) If the teacherId matches the authenticated user's UID, the document exists, and the teacherId in the request data matches the existing document.
     * @allow (delete) If the teacherId matches the authenticated user's UID and the document exists.
     * @deny (create) If the teacherId does not match the authenticated user's UID.
     * @deny (update) If the teacherId does not match the authenticated user's UID.
     * @deny (delete) If the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree, validates relational integrity between documents.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage simulations under their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) If the user is authenticated and the teacherId matches the authenticated user's UID.
     * @allow (get) If the teacherId matches the authenticated user's UID.
     * @allow (list) If the teacherId matches the authenticated user's UID.
     * @allow (update) If the teacherId matches the authenticated user's UID and the document exists.
     * @allow (delete) If the teacherId matches the authenticated user's UID and the document exists.
     * @deny (create) If the teacherId does not match the authenticated user's UID.
     * @deny (update) If the teacherId does not match the authenticated user's UID.
     * @deny (delete) If the teacherId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows students to manage their progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) If the user is authenticated and the studentId matches the authenticated user's UID.
     * @allow (get) If the studentId matches the authenticated user's UID.
     * @allow (list) If the studentId matches the authenticated user's UID.
     * @allow (update) If the studentId matches the authenticated user's UID and the document exists.
     * @allow (delete) If the studentId matches the authenticated user's UID and the document exists.
     * @deny (create) If the studentId does not match the authenticated user's UID.
     * @deny (update) If the studentId does not match the authenticated user's UID.
     * @deny (delete) If the studentId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }

       /**
     * @description Allows students to manage their stored evaluation data for a specific TP.
     * @path /students/{studentId}/storedEvals/{tpId}
     * @allow (create) If the user is authenticated and the studentId matches the authenticated user's UID.
     * @allow (get) If the studentId matches the authenticated user's UID.
     * @allow (list) If the studentId matches the authenticated user's UID.
     * @allow (update) If the studentId matches the authenticated user's UID and the document exists.
     * @allow (delete) If the studentId matches the authenticated user's UID and the document exists.
     * @deny (create) If the studentId does not match the authenticated user's UID.
     * @deny (update) If the studentId does not match the authenticated user's UID.
     * @deny (delete) If the studentId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /students/{studentId}/storedEvals/{tpId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }
  }
}