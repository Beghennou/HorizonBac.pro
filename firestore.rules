/**
 * @file Firestore Security Rules for Formula Skills Garage.
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for teachers and students,
 * with teachers managing their students and training programs.  It also allows students to manage
 * their own progress data.
 *
 * @data_structure
 * - /teachers/{teacherId}: Teacher profiles, where teacherId is the Firebase auth.uid.
 * - /teachers/{teacherId}/students/{studentId}: Student profiles managed by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Training programs created by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Simulations within a training program.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Student progress records.
 * - /assignedTps/{studentId}: Training programs assigned to a student.
 *
 * @key_security_decisions
 * - Teachers can only manage data under their own teacherId path.
 * - Students can only manage their own progress data.
 * - Listing all users is disallowed (except for teachers listing their own students/training programs).
 * - Assumes data denormalization (teacherId in Student, TrainingProgram, and StudentProgress) to avoid expensive `get()` calls in rules.
 * @denormalization_for_authorization
 * The `teacherId` is denormalized into the `Student` and `TrainingProgram` documents to allow simple ownership checks without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows teachers to manage their own profiles.
     * @path /teachers/{teacherId}
     * @allow (get, create, update, delete) if the teacher's auth.uid matches the teacherId.
     * @deny (get, create, update, delete) if the teacher's auth.uid does not match the teacherId.
     * @principle Enforces document ownership for writes and reads.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      allow get: if isOwner(teacherId);
      allow list: if false;
      allow create: if isOwner(teacherId);
      allow update: if isOwner(teacherId) && resource != null;
      allow delete: if isOwner(teacherId) && resource != null;
    }

    /**
     * @description Allows teachers to manage their students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create, update, delete) if the teacher's auth.uid matches the teacherId.
     * @deny (create, update, delete) if the teacher's auth.uid does not match the teacherId.
     * @principle Enforces document ownership for writes.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isOwner(teacherId) && resource != null && request.resource.data.teacherId == teacherId;
      allow delete: if isOwner(teacherId) && resource != null;
    }

    /**
     * @description Allows teachers to manage their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create, update, delete) if the teacher's auth.uid matches the teacherId.
     * @deny (create, update, delete) if the teacher's auth.uid does not match the teacherId.
     * @principle Enforces document ownership for writes.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isOwner(teacherId) && resource != null && request.resource.data.teacherId == teacherId;
      allow delete: if isOwner(teacherId) && resource != null;
    }

    /**
     * @description Allows teachers to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create, update, delete) if the teacher's auth.uid matches the teacherId.
     * @deny (create, update, delete) if the teacher's auth.uid does not match the teacherId.
     * @principle Enforces document ownership for writes.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isOwner(teacherId) && resource != null;
      allow delete: if isOwner(teacherId) && resource != null;
    }

    /**
     * @description Allows students to manage their own progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create, update, delete) if the student's auth.uid matches the studentId.
     * @deny (create, update, delete) if the student's auth.uid does not match the studentId.
     * @principle Enforces document ownership for writes.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isOwner(studentId) && resource != null && request.resource.data.studentId == studentId;
      allow delete: if isOwner(studentId) && resource != null;
    }

    /**
     * @description Allows access to the list of training programs assigned to a student.
     * @path /assignedTps/{studentId}
     * @allow (get) if the user is signed in.
     * @deny (create, update, delete) always.  Writes are not allowed.
     * @principle Enforces read-only access to assigned training programs.
     */
    match /assignedTps/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows students to manage their stored evaluations.
     * @path /students/{studentId}/storedEvals/{tpId}
     * @allow (create, update, delete) if the student's auth.uid matches the studentId.
     * @deny (create, update, delete) if the student's auth.uid does not match the studentId.
     * @principle Enforces document ownership for writes.
     */
    match /students/{studentId}/storedEvals/{tpId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isOwner(studentId) {
          return isSignedIn() && request.auth.uid == studentId;
        }

        allow get: if isOwner(studentId);
        allow list: if isOwner(studentId);
        allow create: if isOwner(studentId);
        allow update: if isOwner(studentId) && resource != null;
        allow delete: if isOwner(studentId) && resource != null;
    }
  }
}