/**
 * @fileoverview Firestore Security Rules for Formula Skills Garage application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict ownership model, primarily based on user IDs derived from Firebase Authentication. Teachers can only manage data associated with their own accounts, and students can only access their own progress data.  The rules prioritize preventing unauthorized data access and modification.
 *
 * Data Structure:
 * The Firestore database is organized hierarchically. Teachers have a dedicated top-level collection (`/teachers/{teacherId}`) under which their students, training programs, and simulations are stored. Student progress is stored under the respective student's document (`/students/{studentId}/studentProgress/{studentProgressId}`).  The teacherId field is denormalized onto the Student and TrainingProgram entities to simplify authorization checks and avoid costly `get()` calls.
 *
 * Key Security Decisions:
 * - Teachers can only create, read, update, and delete data within their own teacherId namespace.
 * - Students can only manage their own progress records.
 * - Listing of all students under a teacher is allowed.
 * - Data validation is limited to ensuring data consistency between the document ID and fields like `teacherId` and `studentId`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Defines the `isSignedIn()` helper function.
     * @principle Allows only signed-in users to access certain features.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Defines the `isOwner(userId)` helper function.
     * @principle Securely checks if the request is made by the owner of a document.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Defines the `isExistingOwner(userId)` helper function.
     * @principle Securely checks if the request is made by the owner of an existing document.
     */
    function isExistingOwner(userId) {
      return isSignedIn() && request.auth.uid == resource.data.teacherId;
    }

    /**
     * @description Enforces that an ownership field (e.g., teacherId) within the document data matches the authenticated user's ID.
     * @principle Prevents unauthorized modification of ownership.
     */
    function matchesOwnerField(field) {
      return request.resource.data[field] == request.auth.uid;
    }

   /**
     * @description Rules for teacher profiles.
     * @path /teachers/{teacherId}
     * @allow (create) Teacher with ID 'teacher123' can create their profile with matching teacherId.
     * @deny (create) User with ID 'otherUser' cannot create a profile with teacherId 'teacher123'.
     * @principle Enforces user-ownership for teacher profiles.
     */
    match /teachers/{teacherId} {
      allow get: if isOwner(teacherId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == teacherId;
      allow update: if isOwner(teacherId);
      allow delete: if isOwner(teacherId);
    }

    /**
     * @description Rules for student profiles under a teacher.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) Teacher 'teacher123' can create a student profile under their teacherId.
     * @deny (create) Teacher 'otherTeacher' cannot create a student profile under teacherId 'teacher123'.
     * @principle Enforces teacher-ownership for student profiles.
     */
    match /teachers/{teacherId}/students/{studentId} {
      allow get: if isSignedIn() && request.auth.uid == teacherId;
      allow list: if isSignedIn() && request.auth.uid == teacherId;
      allow create: if isSignedIn() && request.auth.uid == teacherId;
      allow update: if isSignedIn() && request.auth.uid == teacherId;
      allow delete: if isSignedIn() && request.auth.uid == teacherId;
    }

    /**
     * @description Rules for training programs created by teachers.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) Teacher 'teacher123' can create a training program under their teacherId.
     * @deny (create) Teacher 'otherTeacher' cannot create a training program under teacherId 'teacher123'.
     * @principle Enforces teacher-ownership for training programs.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      allow get: if isSignedIn() && request.auth.uid == teacherId;
      allow list: if isSignedIn() && request.auth.uid == teacherId;
      allow create: if isSignedIn() && request.auth.uid == teacherId;
      allow update: if isSignedIn() && request.auth.uid == teacherId;
      allow delete: if isSignedIn() && request.auth.uid == teacherId;
    }

    /**
     * @description Rules for simulations within training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) Teacher 'teacher123' can create a simulation under their training program.
     * @deny (create) Teacher 'otherTeacher' cannot create a simulation under teacherId 'teacher123'.
     * @principle Enforces teacher-ownership for simulations.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      allow get: if isSignedIn() && request.auth.uid == teacherId;
      allow list: if isSignedIn() && request.auth.uid == teacherId;
      allow create: if isSignedIn() && request.auth.uid == teacherId;
      allow update: if isSignedIn() && request.auth.uid == teacherId;
      allow delete: if isSignedIn() && request.auth.uid == teacherId;
    }

    /**
     * @description Rules for student progress records.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) Student 'student123' can create a progress record under their studentId.
     * @deny (create) Student 'otherStudent' cannot create a progress record under studentId 'student123'.
     * @principle Enforces student-ownership for progress records.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      allow get: if isOwner(studentId);
      allow list: if false;
      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow delete: if isOwner(studentId);
    }
  }
}