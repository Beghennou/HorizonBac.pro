/**
 * @file Firestore Security Rules for Formula Skills Garage application.
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model, primarily based on
 *                  the `teacherId` field. Teachers can only access or modify data related to
 *                  their own students and training programs.  Students have access to their
 *                  own progress data. All writes require authentication.
 *
 * @data_structure The data is structured hierarchically under `/teachers/{teacherId}` for teacher-owned
 *                 data (students, training programs, simulations) and `/students/{studentId}` for
 *                 student-owned data (studentProgress, storedEvals).  This allows for clear
 *                 ownership and efficient querying.
 *
 * @key_security_decisions
 *   - User listing is generally disallowed except for subcollections that belong to a teacher.
 *   - The rules explicitly deny any write operation that bypasses ownership checks.
 *   - Data consistency is enforced by validating the path parameters against document fields
 *     during creation and update.
 *   - The `storedEvals` collection is a subcollection of `students` to improve data locality and security.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Allows a teacher to manage their own profile.
     * @path /teachers/{teacherId}
     * @allow (create) - Teacher with ID 'teacher123' can create their profile if authenticated as 'teacher123'.
     * @allow (get) - Teacher with ID 'teacher123' can read their profile if authenticated as 'teacher123'.
     * @allow (update) - Teacher with ID 'teacher123' can update their profile if authenticated as 'teacher123'.
     * @allow (delete) - Teacher with ID 'teacher123' can delete their profile if authenticated as 'teacher123'.
     * @deny (create) - Teacher with ID 'teacher123' cannot create a profile for 'teacher456'.
     * @deny (update) - Teacher with ID 'teacher123' cannot update the profile of 'teacher456'.
     * @principle Enforces document ownership for all operations.
     */
    match /teachers/{teacherId} {
      allow get: if isOwner(teacherId);
      allow list: if false;
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows a teacher to manage their students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) - Teacher with ID 'teacher123' can create a student profile under their node if authenticated as 'teacher123' and the student's teacherId is also 'teacher123'.
     * @allow (get) - Teacher with ID 'teacher123' can read a student profile under their node if authenticated as 'teacher123'.
     * @allow (list) - Teacher with ID 'teacher123' can list student profiles under their node if authenticated as 'teacher123'.
     * @allow (update) - Teacher with ID 'teacher123' can update a student profile under their node if authenticated as 'teacher123' and the student's teacherId remains 'teacher123'.
     * @allow (delete) - Teacher with ID 'teacher123' can delete a student profile under their node if authenticated as 'teacher123'.
     * @deny (create) - Teacher with ID 'teacher123' cannot create a student profile with teacherId 'teacher456'.
     * @deny (update) - Teacher with ID 'teacher123' cannot update a student profile and change the teacherId to 'teacher456'.
     * @principle Enforces teacher ownership for student data and validates data consistency.
     */
    match /teachers/{teacherId}/students/{studentId} {
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows a teacher to manage their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) - Teacher with ID 'teacher123' can create a training program under their node if authenticated as 'teacher123' and the training program's teacherId is also 'teacher123'.
     * @allow (get) - Teacher with ID 'teacher123' can read a training program under their node if authenticated as 'teacher123'.
     * @allow (list) - Teacher with ID 'teacher123' can list training programs under their node if authenticated as 'teacher123'.
     * @allow (update) - Teacher with ID 'teacher123' can update a training program under their node if authenticated as 'teacher123' and the training program's teacherId remains 'teacher123'.
     * @allow (delete) - Teacher with ID 'teacher123' can delete a training program under their node if authenticated as 'teacher123'.
     * @deny (create) - Teacher with ID 'teacher123' cannot create a training program with teacherId 'teacher456'.
     * @deny (update) - Teacher with ID 'teacher123' cannot update a training program and change the teacherId to 'teacher456'.
     * @principle Enforces teacher ownership for training program data and validates data consistency.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows a teacher to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) - Teacher 'teacher123' creates a simulation under their training program.
     * @allow (get) - Teacher 'teacher123' reads a simulation under their training program.
     * @allow (list) - Teacher 'teacher123' lists simulations under their training program.
     * @allow (update) - Teacher 'teacher123' updates a simulation under their training program.
     * @allow (delete) - Teacher 'teacher123' deletes a simulation under their training program.
     * @deny (create) - User 'student456' attempts to create a simulation under teacher 'teacher123's training program.
     * @deny (update) - User 'student456' attempts to update a simulation under teacher 'teacher123's training program.
     * @principle Enforces teacher ownership for simulation data.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows a student to manage their own progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) - Student with ID 'student123' can create progress data under their node if authenticated as 'student123'.
     * @allow (get) - Student with ID 'student123' can read progress data under their node if authenticated as 'student123'.
     * @allow (list) - Student with ID 'student123' can list progress data under their node if authenticated as 'student123'.
     * @allow (update) - Student with ID 'student123' can update progress data under their node if authenticated as 'student123'.
     * @allow (delete) - Student with ID 'student123' can delete progress data under their node if authenticated as 'student123'.
     * @deny (create) - Student with ID 'student123' cannot create progress data under the node of 'student456'.
     * @deny (update) - Student with ID 'student123' cannot update progress data under the node of 'student456'.
     * @principle Enforces document ownership for student progress data.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.studentId == resource.data.studentId;
      allow delete: if isExistingOwner(studentId);
    }

     /**
      * @description Allows a student to manage their own evaluation data.
      * @path /students/{studentId}/storedEvals/{tpId}
      * @allow (create) - Student 'student123' creates an eval under their node.
      * @allow (get) - Student 'student123' reads an eval under their node.
      * @allow (list) - Student 'student123' lists evals under their node.
      * @allow (update) - Student 'student123' updates an eval under their node.
      * @allow (delete) - Student 'student123' deletes an eval under their node.
      * @deny (create) - User 'teacher456' attempts to create an eval under student 'student123's node.
      * @deny (update) - User 'teacher456' attempts to update an eval under student 'student123's node.
      * @principle Enforces document ownership for stored evaluation data.
      */
    match /students/{studentId}/storedEvals/{tpId} {
      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }
  }
}