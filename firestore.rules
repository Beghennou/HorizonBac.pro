/**
 * @file Firestore Security Rules for Formula Skills Garage.
 *
 * @Core Philosophy:
 * This ruleset enforces a strict user-ownership model, ensuring that teachers can only manage data directly associated with their accounts, and students can only access their own progress data.
 *
 * @Data Structure:
 * - /teachers/{teacherId}: Stores teacher profiles. teacherId MUST match the authenticated user's UID.
 * - /teachers/{teacherId}/students/{studentId}: Stores student profiles managed by a teacher. Each student document contains a `teacherId` field for authorization.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Stores training programs created by teachers. Each training program contains a `teacherId` field for authorization.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Stores simulation data related to training programs.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Stores student progress data.
 *
 * @Key Security Decisions:
 * - Teachers have full CRUD access to their own students, training programs, and simulations.
 * - Students have full CRUD access to their own student progress.
 * - Listing of teachers is denied.
 * - Data consistency between document IDs and path parameters is enforced on creation and updates to prevent unauthorized data manipulation.
 *
 * @Denormalization for Authorization:
 * - The `teacherId` is denormalized into the Student and TrainingProgram documents to allow for efficient authorization checks without requiring additional `get()` calls.
 * - Explicit `studentId`, `trainingProgramId`, and `simulationId` fields are included in StudentProgress documents to maintain relational integrity and enable simple path-based access control.
 *
 * @Structural Segregation:
 * - Teacher-owned data is stored under /teachers/{teacherId}, while student-owned data is stored under /students/{studentId}. This segregation ensures that teachers can only manage data within their designated paths.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description: Protects teacher profiles, ensuring only the authenticated user can manage their own profile.
     * @path: /teachers/{teacherId}
     * @allow: (create) User with UID 'teacher_abc' can create a profile at /teachers/teacher_abc.
     * @deny: (create) User with UID 'teacher_xyz' cannot create a profile at /teachers/teacher_abc.
     * @principle: Enforces document ownership, restricting access to a user's own data tree.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && exists(resource);
      }

      allow get: if isOwner(teacherId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(teacherId);
      allow update: if isSignedIn() && isExistingOwner(teacherId);
      allow delete: if isSignedIn() && isExistingOwner(teacherId);
    }

    /**
     * @description: Manages students for a specific teacher, ensuring the teacherId matches the authenticated user.
     * @path: /teachers/{teacherId}/students/{studentId}
     * @allow: (create) Teacher with UID 'teacher_abc' can create a student profile at /teachers/teacher_abc/students/student_123.
     * @deny: (create) Teacher with UID 'teacher_xyz' cannot create a student profile at /teachers/teacher_abc/students/student_123.
     * @principle: Enforces document ownership, restricting access to a user's own data tree and validating relational integrity.
     */
    match /teachers/{teacherId}/students/{studentId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(teacherId) {
            return request.auth.uid == teacherId;
        }

        function isExistingOwner(teacherId) {
            return isOwner(teacherId) && exists(resource);
        }

        allow get: if isOwner(teacherId);
        allow list: if isOwner(teacherId);
        allow create: if isSignedIn() && isOwner(teacherId) && request.resource.data.teacherId == teacherId;
        allow update: if isSignedIn() && isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
        allow delete: if isSignedIn() && isExistingOwner(teacherId);
    }

    /**
     * @description: Manages training programs created by a specific teacher, ensuring the teacherId matches the authenticated user.
     * @path: /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow: (create) Teacher with UID 'teacher_abc' can create a training program at /teachers/teacher_abc/trainingPrograms/tp_123.
     * @deny: (create) Teacher with UID 'teacher_xyz' cannot create a training program at /teachers/teacher_abc/trainingPrograms/tp_123.
     * @principle: Enforces document ownership, restricting access to a user's own data tree and validating relational integrity.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(teacherId) {
            return request.auth.uid == teacherId;
        }

        function isExistingOwner(teacherId) {
            return isOwner(teacherId) && exists(resource);
        }

        allow get: if isOwner(teacherId);
        allow list: if isOwner(teacherId);
        allow create: if isSignedIn() && isOwner(teacherId) && request.resource.data.teacherId == teacherId;
        allow update: if isSignedIn() && isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
        allow delete: if isSignedIn() && isExistingOwner(teacherId);
    }

    /**
     * @description: Manages simulations associated with training programs, ensuring the teacherId matches the authenticated user.
     * @path: /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow: (create) Teacher with UID 'teacher_abc' can create a simulation at /teachers/teacher_abc/trainingPrograms/tp_123/simulations/sim_123.
     * @deny: (create) Teacher with UID 'teacher_xyz' cannot create a simulation at /teachers/teacher_abc/trainingPrograms/tp_123/simulations/sim_123.
     * @principle: Enforces document ownership, restricting access to a user's own data tree.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(teacherId) {
            return request.auth.uid == teacherId;
        }

        function isExistingOwner(teacherId) {
            return isOwner(teacherId) && exists(resource);
        }

        allow get: if isOwner(teacherId);
        allow list: if isOwner(teacherId);
        allow create: if isSignedIn() && isOwner(teacherId);
        allow update: if isSignedIn() && isExistingOwner(teacherId);
        allow delete: if isSignedIn() && isExistingOwner(teacherId);
    }

    /**
     * @description: Manages student progress data, ensuring the studentId matches the authenticated user.
     * @path: /students/{studentId}/studentProgress/{studentProgressId}
     * @allow: (create) Student with UID 'student_abc' can create a progress record at /students/student_abc/studentProgress/progress_123.
     * @deny: (create) Student with UID 'student_xyz' cannot create a progress record at /students/student_abc/studentProgress/progress_123.
     * @principle: Enforces document ownership, restricting access to a user's own data tree.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(studentId) {
            return request.auth.uid == studentId;
        }

        function isExistingOwner(studentId) {
            return isOwner(studentId) && exists(resource);
        }

        allow get: if isOwner(studentId);
        allow list: if isOwner(studentId);
        allow create: if isSignedIn() && isOwner(studentId) && request.resource.data.studentId == studentId;
        allow update: if isSignedIn() && isExistingOwner(studentId) && resource.data.studentId == request.resource.data.studentId;
        allow delete: if isSignedIn() && isExistingOwner(studentId);
    }
  }
}