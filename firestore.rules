/**
 * @file Firestore Security Rules for Formula Skills Garage Application
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model, augmented by teacher-based access for student and training program data.
 *   Teachers have full control over their own data (training programs, simulations) and the data of their assigned students.
 *
 * @data_structure Data is organized hierarchically under `/teachers/{teacherId}` and `/students/{studentId}`.
 *   Teacher profiles are stored at the root level. Student profiles, training programs, and simulations are nested under the respective teacher's node.
 *   Student progress is stored under each student's node.
 *
 * @key_security_decisions
 *   - Teachers can only manage data related to their own students and training programs.
 *   - Students can only access their own progress data.
 *   - Listing of teachers is disallowed for privacy.
 *
 * @denormalization_for_authorization The `teacherId` field is denormalized into the `Student` and `TrainingProgram` documents to allow direct authorization checks
 *   without requiring additional `get()` calls. This ensures efficient and scalable security rules.
 *
 * @structural_segregation User-specific data (student profiles, training programs, student progress) is stored in dedicated subcollections
 *   under the respective `/teachers/{teacherId}` and `/students/{studentId}` paths to enforce clear ownership and access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Validates that the authenticated user is the owner (teacher) of the resource.
     * @param {string} userId The user ID to compare against the authenticated user's UID.
     * @return {bool} True if the user ID matches the authenticated user's UID, false otherwise.
     */
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description Validates that the authenticated user is the existing owner (teacher) of the resource and that the resource exists.
     * @param {string} userId The user ID to compare against the authenticated user's UID.
     * @return {bool} True if the user ID matches the authenticated user's UID and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }


    /**
     * @description Defines access rules for the /teachers/{teacherId} collection.
     * @path /teachers/{teacherId}
     * @allow (create) User with auth.uid "teacher123" can create a teacher profile with id "teacher123".
     * @deny (create) User with auth.uid "student456" cannot create a teacher profile with id "teacher123".
     * @allow (get) User with auth.uid "teacher123" can read his/her profile with id "teacher123".
     * @deny (get) User with auth.uid "student456" cannot read teacher's profile.
     * @principle Enforces ownership for teacher profiles, ensuring only the authenticated teacher can manage their own profile.
     */
    match /teachers/{teacherId} {
      allow get: if isOwner(teacherId);
      allow list: if false;
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Defines access rules for the /teachers/{teacherId}/students/{studentId} collection.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) Teacher "teacher123" can create a student profile under their node.
     * @deny (create) Teacher "teacher456" cannot create a student profile under "teacher123"'s node.
     * @allow (get) Teacher "teacher123" can read student "student456" profile under their node.
     * @deny (get) Teacher "teacher456" cannot read student "student456" profile under "teacher123"'s node.
     * @principle Enforces teacher-based ownership for student profiles, ensuring only the teacher associated with the student can manage the profile.
     */
    match /teachers/{teacherId}/students/{studentId} {
      allow get, list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Defines access rules for the /teachers/{teacherId}/trainingPrograms/{trainingProgramId} collection.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) Teacher "teacher123" can create a training program under their node.
     * @deny (create) Teacher "teacher456" cannot create a training program under "teacher123"'s node.
     * @allow (get) Teacher "teacher123" can read training program "tp789" under their node.
     * @deny (get) Teacher "teacher456" cannot read training program "tp789" under "teacher123"'s node.
     * @principle Enforces teacher-based ownership for training programs, ensuring only the creating teacher can manage them.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      allow get, list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Defines access rules for the /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} collection.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) Teacher "teacher123" can create a simulation under their training program.
     * @deny (create) Teacher "teacher456" cannot create a simulation under "teacher123"'s training program.
     * @allow (get) Teacher "teacher123" can read simulation "sim101" under their training program.
     * @deny (get) Teacher "teacher456" cannot read simulation "sim101" under "teacher123"'s training program.
     * @principle Enforces teacher-based ownership for simulations, ensuring only the associated teacher can manage them.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      allow get, list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Defines access rules for the /students/{studentId}/studentProgress/{studentProgressId} collection.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) Student "student123" can create a progress record under their node.
     * @deny (create) Student "student456" cannot create a progress record under "student123"'s node.
     * @allow (get) Student "student123" can read progress record "progress789" under their node.
     * @deny (get) Student "student456" cannot read progress record "progress789" under "student123"'s node.
     * @principle Enforces student-based ownership for student progress, ensuring only the student can manage their own progress data.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      allow get, list: if isOwner(studentId);
      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.studentId == resource.data.studentId;
      allow delete: if isExistingOwner(studentId);
    }
    
      /**
       * @description Defines access rules for the /students/{studentId}/storedEvals/{tpId} collection.
       * @path /students/{studentId}/storedEvals/{tpId}
       * @allow (create) Student "student123" can create a storedEval record under their node.
       * @deny (create) Student "student456" cannot create a storedEval record under "student123"'s node.
       * @allow (get) Student "student123" can read storedEval record "eval789" under their node.
       * @deny (get) Student "student456" cannot read storedEval record "eval789" under "student123"'s node.
       * @principle Enforces student-based ownership for stored evaluations, ensuring only the student can manage their own evaluation data.
       */
    match /students/{studentId}/storedEvals/{tpId} {
      allow get, list: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Defines access rules for the /assignedTps/{studentId} collection.
     * @path /assignedTps/{studentId}
     * @allow (create) Any authenticated user can create an assigned TP list.
     * @deny (create) Non-authenticated user can not create an assigned TP list.
     * @allow (get) Any authenticated user can get an assigned TP list.
     * @deny (get) Non-authenticated user can not get an assigned TP list.
     */
    match /assignedTps/{studentId} {
       allow get, list: if isSignedIn();
       allow create, update, delete: if isSignedIn();
    }
  }
}