/**
 * @fileOverview Firestore Security Rules for the Formula Skills Garage application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model, ensuring that teachers can only
 * access and modify data related to their own students and training programs.  Students
 * can only access their own progress data.
 *
 * Data Structure:
 * - /teachers/{teacherId}: Stores teacher profiles. The teacherId MUST match the Firebase auth.uid.
 * - /teachers/{teacherId}/students/{studentId}: Stores student profiles, linked to a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Stores training programs created by teachers.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Stores simulation data for training programs.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Stores student progress data.
 *
 * Key Security Decisions:
 * - Teachers can only manage students and training programs associated with their account (teacherId).
 * - Students can only access their own progress records.
 * - Listing of teachers is disallowed for privacy.
 *
 * Denormalization for Authorization:
 * The `teacherId` is denormalized into the `Student` and `TrainingProgram` documents to
 * allow direct authorization checks without requiring additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure the `/teachers/{teacherId}` collection.  Teachers can only read and write their own profile.
     * @path /teachers/{teacherId}
     * @allow (create) - A teacher with UID 'teacher123' can create their profile if teacherId == auth.uid.
     * @allow (get, update, delete) - A teacher with UID 'teacher123' can get, update, or delete their profile if teacherId == auth.uid.
     * @deny (create) - A teacher with UID 'teacher123' cannot create a profile with teacherId = 'otherTeacherId'.
     * @deny (get, update, delete) - A teacher with UID 'teacher123' cannot get, update, or delete a profile with teacherId = 'otherTeacherId'.
     * @principle Enforces document ownership for teachers.
     */
    match /teachers/{teacherId} {
      function isOwner(teacherId) {
        return request.auth != null && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if false; // Teachers collection is not listable

      allow create: if isOwner(teacherId) && request.resource.data.id == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Secure the `/teachers/{teacherId}/students/{studentId}` collection.  Teachers can manage their own students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) - A teacher with UID 'teacher123' can create a student under /teachers/teacher123/students/student456.
     * @allow (get, list, update, delete) - A teacher with UID 'teacher123' can get, list, update, or delete a student under /teachers/teacher123/students/student456.
     * @deny (create) - A teacher with UID 'teacher123' cannot create a student under /teachers/otherTeacherId/students/student456.
     * @deny (get, list, update, delete) - A teacher with UID 'teacher123' cannot get, list, update, or delete a student under /teachers/otherTeacherId/students/student456.
     * @principle Enforces teacher ownership for student profiles.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isOwner(teacherId) {
        return request.auth != null && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Secure the `/teachers/{teacherId}/trainingPrograms/{trainingProgramId}` collection. Teachers can manage their own training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) - A teacher with UID 'teacher123' can create a training program under /teachers/teacher123/trainingPrograms/tp123.
     * @allow (get, list, update, delete) - A teacher with UID 'teacher123' can get, list, update, or delete a training program under /teachers/teacher123/trainingPrograms/tp123.
     * @deny (create) - A teacher with UID 'teacher123' cannot create a training program under /teachers/otherTeacherId/trainingPrograms/tp123.
     * @deny (get, list, update, delete) - A teacher with UID 'teacher123' cannot get, list, update, or delete a training program under /teachers/otherTeacherId/trainingPrograms/tp123.
     * @principle Enforces teacher ownership for training programs.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isOwner(teacherId) {
        return request.auth != null && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Secure the `/teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}` collection. Teachers can manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) - A teacher with UID 'teacher123' can create a simulation under /teachers/teacher123/trainingPrograms/tp123/simulations/sim123.
     * @allow (get, list, update, delete) - A teacher with UID 'teacher123' can get, list, update, or delete a simulation under /teachers/teacher123/trainingPrograms/tp123/simulations/sim123.
     * @deny (create) - A teacher with UID 'teacher123' cannot create a simulation under /teachers/otherTeacherId/trainingPrograms/tp123/simulations/sim123.
     * @deny (get, list, update, delete) - A teacher with UID 'teacher123' cannot get, list, update, or delete a simulation under /teachers/otherTeacherId/trainingPrograms/tp123/simulations/sim123.
     * @principle Enforces teacher ownership for simulations within training programs.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isOwner(teacherId) {
        return request.auth != null && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Secure the `/students/{studentId}/studentProgress/{studentProgressId}` collection. Students can only access their own progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) - A student with UID 'student123' can create progress data under /students/student123/studentProgress/sp123.
     * @allow (get, list, update, delete) - A student with UID 'student123' can get, list, update, or delete progress data under /students/student123/studentProgress/sp123.
     * @deny (create) - A student with UID 'student123' cannot create progress data under /students/otherStudentId/studentProgress/sp123.
     * @deny (get, list, update, delete) - A student with UID 'student123' cannot get, list, update, or delete progress data under /students/otherStudentId/studentProgress/sp123.
     * @principle Enforces student ownership for progress data.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isOwner(studentId) {
        return request.auth != null && request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.studentId == resource.data.studentId;
      allow delete: if isExistingOwner(studentId);
    }
  }
}