/**
 * @file Firebase Security Rules for Formula Skills Garage application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for teachers and students.
 * Teachers can manage their own students and training programs. Students can only access their own progress data.
 *
 * Data Structure:
 * - /teachers/{teacherId}: Stores teacher profiles. teacherId must match the authenticated user's UID.
 * - /teachers/{teacherId}/students/{studentId}: Stores student profiles managed by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Stores training programs created by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Stores simulations within a training program.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Stores student progress data.
 * - /assignedTps/{studentId}: Stores assigned training programs for students.
 * - /storedEvals/{evalId}: Stores evaluation data.
 *
 * Key Security Decisions:
 * - Teachers can only manage students and training programs associated with their teacherId.
 * - Students can only access their own progress data based on their studentId.
 * - Listing of users (teachers or students) is generally disallowed to prevent information disclosure.
 * - Data consistency between document IDs and internal fields is enforced on creation and updates.
 *
 * Denormalization for Authorization:
 * - The `teacherId` is denormalized into the `Student` and `TrainingProgram` documents to avoid needing to perform extra `get()` calls during authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows teachers to manage their own profiles.
     * @path /teachers/{teacherId}
     * @allow (create, update, get, delete) if the request is made by the teacher with matching teacherId.
     * @deny (create, update, delete) if the request is made by a different user.
     * @principle Enforces document ownership for writes.
     */
    match /teachers/{teacherId} {
      function isOwner(teacherId) {
        return request.auth != null && request.auth.uid == teacherId;
      }
      allow get: if isOwner(teacherId);
      allow list: if false; // Listing teachers is not allowed.
      allow create: if isOwner(teacherId) && request.resource.data.id == request.auth.uid;
      allow update: if isOwner(teacherId) && resource.data.id == request.auth.uid;
      allow delete: if isOwner(teacherId) && resource.data.id == request.auth.uid;
    }

    /**
     * @description Allows teachers to manage students associated with their teacherId.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create, update, get, delete) if the request is made by the teacher with matching teacherId.
     * @deny (create, update, delete) if the request is made by a different teacher.
     * @principle Enforces document ownership for writes.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isOwner(teacherId) {
        return request.auth != null && request.auth.uid == teacherId;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isOwner(teacherId) && resource.data.teacherId == teacherId;
      allow delete: if isOwner(teacherId) && resource.data.teacherId == teacherId;
    }

    /**
     * @description Allows teachers to manage training programs associated with their teacherId.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create, update, get, delete) if the request is made by the teacher with matching teacherId.
     * @deny (create, update, delete) if the request is made by a different teacher.
     * @principle Enforces document ownership for writes.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isOwner(teacherId) {
        return request.auth != null && request.auth.uid == teacherId;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isOwner(teacherId) && resource.data.teacherId == teacherId;
      allow delete: if isOwner(teacherId) && resource.data.teacherId == teacherId;
    }

    /**
     * @description Allows teachers to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create, update, get, delete) if the request is made by the teacher with matching teacherId.
     * @deny (create, update, delete) if the request is made by a different teacher.
     * @principle Enforces document ownership for writes.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isOwner(teacherId) {
        return request.auth != null && request.auth.uid == teacherId;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isOwner(teacherId);
      allow delete: if isOwner(teacherId);
    }

    /**
     * @description Allows students to access their own progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (get) if the request is made by the student with matching studentId.
     * @deny (create, update, delete) for all users. Only backend services can modify this data.
     * @principle Restricts access to a user's own data tree.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isOwner(studentId) {
        return request.auth != null && request.auth.uid == studentId;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores the list of TPs assigned to a student. Only that student can read, no one can write.
     * @path /assignedTps/{studentId}
     */
    match /assignedTps/{studentId} {
      function isOwner(studentId) {
        return request.auth != null && request.auth.uid == studentId;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    /**
     * @description Allows all signed-in users to read stored evaluations.
     * @path /storedEvals/{evalId}
     * @allow (get, list) if the user is signed in.
     * @deny (create, update, delete) for all users.
     * @principle Allows public read access to evaluation data, while restricting write access.
     */
    match /storedEvals/{evalId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}