/**
 * @fileOverview Firestore Security Rules for Formula Skills Garage.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Teachers can only manage data related to their own students and training programs. Students can only access their own progress data.
 *
 * Data Structure:
 * - /teachers/{teacherId}: Stores teacher profiles. teacherId must match the authenticated user's UID.
 * - /teachers/{teacherId}/students/{studentId}: Stores student profiles managed by a specific teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Stores training programs created by a specific teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Stores simulation data for a specific training program.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Stores student progress data.
 *
 * Key Security Decisions:
 * - Teachers can only create, read, update, and delete data related to their students and training programs.
 * - Students can only read and update their own progress data.
 * - Data consistency is enforced by matching the path parameters with fields in the documents.
 * - List operations are secured by path-based ownership.
 *
 * Denormalization for Authorization:
 * The `teacherId` field is denormalized into the Student and TrainingProgram collections to allow direct authorization checks without additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Allows teachers to manage their profile.
     * @path /teachers/{teacherId}
     * @allow (create) User with UID 'teacher123' can create a teacher profile with teacherId 'teacher123'.
     * @deny (create) User with UID 'student456' cannot create a teacher profile with teacherId 'teacher123'.
     * @principle Enforces document ownership for writes; teachers can only create their profile.
     */
    match /teachers/{teacherId} {
      allow get: if isOwner(teacherId);
      allow list: if false; // Teachers collection is not intended to be listable.
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) Teacher 'teacher123' can create a student 'student456' under their profile.
     * @deny (create) Teacher 'teacher123' cannot create a student 'student456' under another teacher's profile ('teacher789').
     * @principle Enforces document ownership for writes; teachers can only manage students under their profile.
     */
    match /teachers/{teacherId}/students/{studentId} {
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) Teacher 'teacher123' can create a training program 'tp789' under their profile.
     * @deny (create) Teacher 'teacher123' cannot create a training program 'tp789' under another teacher's profile ('teacher789').
     * @principle Enforces document ownership for writes; teachers can only manage training programs under their profile.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) Teacher 'teacher123' can create a simulation 'sim456' within their training program 'tp789'.
     * @deny (create) Teacher 'teacher123' cannot create a simulation 'sim456' under another teacher's training program.
     * @principle Enforces document ownership for writes; teachers can only manage simulations within their training programs.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows students to manage their progress.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) Student 'student456' can create a progress record 'progress123' under their profile.
     * @deny (create) Student 'student456' cannot create a progress record 'progress123' under another student's profile ('student789').
     * @principle Enforces document ownership for writes; students can only manage progress under their profile.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.studentId == resource.data.studentId;
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Allows access to evaluation data for a student on a specific TP.
     * @path /students/{studentId}/storedEvals/{tpId}
     * @allow read: Student can read their own evaluation data.
     * @allow write: Student can write their own evaluation data.
     * @principle Enforces that only the student can read/write their own data.
     */
    match /students/{studentId}/storedEvals/{tpId} {
        allow get: if isOwner(studentId);
        allow list: if isOwner(studentId); // Only the student can list their own evaluations
        allow create: if isOwner(studentId);
        allow update: if isExistingOwner(studentId);
        allow delete: if isExistingOwner(studentId);
    }
  }
}