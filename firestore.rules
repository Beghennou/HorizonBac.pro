/**
 * @fileOverview
 * This ruleset enforces a strict user-ownership model for the Formula Skills Garage application.
 * All data is nested under user-specific paths (`/teachers/{teacherId}` or `/students/{studentId}`), ensuring that only the authenticated user (teacher or student) has access to their respective data.
 *
 * Data Structure:
 * - /teachers/{teacherId}: Stores teacher profiles, where {teacherId} must match the authenticated user's UID.
 * - /teachers/{teacherId}/students/{studentId}: Stores student profiles associated with a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Stores training programs created by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Stores simulations associated with a training program.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Stores student progress data.
 *
 * Key Security Decisions:
 * - Teachers can only manage students, training programs, and simulations that they own (i.e., the teacherId in the path matches their UID).
 * - Students can only access their own progress data (i.e., the studentId in the path matches their UID).
 * - Listing of student progress is allowed for the owning student.
 * - No global roles or admin privileges are defined in this initial prototype.
 *
 * Denormalization for Authorization:
 * - The `teacherId` is denormalized into the `Student` and `TrainingProgram` documents to allow direct ownership checks without additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows teachers to manage their own profile data.
     * @path /teachers/{teacherId}
     * @allow (create) User with UID 'teacher_abc' can create their profile at /teachers/teacher_abc.
     * @deny (create) User with UID 'teacher_xyz' cannot create a profile at /teachers/teacher_abc.
     * @allow (get) User with UID 'teacher_abc' can read their profile at /teachers/teacher_abc.
     * @deny (get) User with UID 'teacher_xyz' cannot read the profile at /teachers/teacher_abc.
     * @allow (update) User with UID 'teacher_abc' can update their profile at /teachers/teacher_abc.
     * @deny (update) User with UID 'teacher_xyz' cannot update the profile at /teachers/teacher_abc.
     * @allow (delete) User with UID 'teacher_abc' can delete their profile at /teachers/teacher_abc.
     * @deny (delete) User with UID 'teacher_xyz' cannot delete the profile at /teachers/teacher_abc.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /teachers/{teacherId} {
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }
      allow get: if true;
      allow list: if false;
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) Teacher with UID 'teacher_abc' can create a student for themselves at /teachers/teacher_abc/students/student_123.
     * @deny (create) Teacher with UID 'teacher_xyz' cannot create a student for teacher_abc.
     * @allow (get) Teacher with UID 'teacher_abc' can read a student they own.
     * @deny (get) Teacher with UID 'teacher_xyz' cannot read a student owned by teacher_abc.
     * @allow (update) Teacher with UID 'teacher_abc' can update a student they own.
     * @deny (update) Teacher with UID 'teacher_xyz' cannot update a student owned by teacher_abc.
     * @allow (delete) Teacher with UID 'teacher_abc' can delete a student they own.
     * @deny (delete) Teacher with UID 'teacher_xyz' cannot delete a student owned by teacher_abc.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
        function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
      allow delete: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
    }

    /**
     * @description Allows teachers to manage their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) Teacher 'teacher_abc' can create a training program under their ID.
     * @deny (create) Teacher 'teacher_xyz' cannot create a training program under 'teacher_abc' ID.
     * @allow (get) Teacher 'teacher_abc' can read a training program under their ID.
     * @deny (get) Teacher 'teacher_xyz' cannot read a training program under 'teacher_abc' ID.
     * @allow (update) Teacher 'teacher_abc' can update a training program under their ID.
     * @deny (update) Teacher 'teacher_xyz' cannot update a training program under 'teacher_abc' ID.
     * @allow (delete) Teacher 'teacher_abc' can delete a training program under their ID.
     * @deny (delete) Teacher 'teacher_xyz' cannot delete a training program under 'teacher_abc' ID.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
        function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
      allow delete: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
    }

    /**
     * @description Allows teachers to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) Teacher 'teacher_abc' can create a simulation in their training program.
     * @deny (create) Teacher 'teacher_xyz' cannot create a simulation in 'teacher_abc's training program.
     * @allow (get) Teacher 'teacher_abc' can read a simulation in their training program.
     * @deny (get) Teacher 'teacher_xyz' cannot read a simulation in 'teacher_abc's training program.
     * @allow (update) Teacher 'teacher_abc' can update a simulation in their training program.
     * @deny (update) Teacher 'teacher_xyz' cannot update a simulation in 'teacher_abc's training program.
     * @allow (delete) Teacher 'teacher_abc' can delete a simulation in their training program.
     * @deny (delete) Teacher 'teacher_xyz' cannot delete a simulation in 'teacher_abc's training program.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows students to manage their own progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) Student 'student_abc' can create progress data under their ID.
     * @deny (create) Student 'student_xyz' cannot create progress data under 'student_abc' ID.
     * @allow (get) Student 'student_abc' can read progress data under their ID.
     * @deny (get) Student 'student_xyz' cannot read progress data under 'student_abc' ID.
     * @allow (update) Student 'student_abc' can update progress data under their ID.
     * @deny (update) Student 'student_xyz' cannot update progress data under 'student_abc' ID.
     * @allow (delete) Student 'student_abc' can delete progress data under their ID.
     * @deny (delete) Student 'student_xyz' cannot delete progress data under 'student_abc' ID.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }
      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }
      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId) && resource.data.studentId == studentId;
      allow delete: if isExistingOwner(studentId) && resource.data.studentId == studentId;
    }
  }
}