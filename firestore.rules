/**
 * @file Firestore Security Rules for Formula Skills Garage application.
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model, primarily based on `teacherId` for teachers and `studentId` for students.
 * Data is segregated into teacher-owned and student-owned subcollections to simplify access control.
 *
 * @data_structure
 * - `/teachers/{teacherId}`: Stores teacher profiles. `teacherId` must match the authenticated user's UID.
 * - `/teachers/{teacherId}/students/{studentId}`: Stores student profiles associated with a teacher.
 * - `/teachers/{teacherId}/trainingPrograms/{trainingProgramId}`: Stores training programs created by teachers.
 * - `/teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}`: Stores simulation data associated with training programs.
 * - `/students/{studentId}/studentProgress/{studentProgressId}`: Stores student progress data.
 *
 * @key_security_decisions
 * - Teachers can only manage data (students, training programs, simulations) under their own `teacherId`.
 * - Students can only manage their own progress data.
 * - Listing of user documents is allowed within their respective subcollections.
 * - The `config` collection is publicly readable by authenticated users.
 *
 * @denormalization_for_authorization `teacherId` is denormalized into the `Student` and `TrainingProgram` documents to allow direct authorization checks without additional reads.
 *
 * @structural_segregation User-specific data is stored in subcollections under the user's document (e.g., `/teachers/{teacherId}/students/{studentId}`) to simplify authorization and improve query performance.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows read access to configuration documents for all authenticated users.
     * @path /config/{configId}
     * @allow (get, list): Authenticated user can read any config document.
     * @deny (create, update, delete): No client-side creation, update, or deletion allowed.
     * @principle Allows public read access for authenticated users while restricting write access.
     */
    match /config/{configId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow read: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows teachers to manage their own profiles.
     * @path /teachers/{teacherId}
     * @allow (get, list): Owner can read their profile.
     * @allow (create): Owner can create their profile if the teacherId matches their auth.uid.
     * @allow (update, delete): Owner can update/delete their profile if it exists.
     * @deny (create): Creation is denied if the teacherId does not match the auth.uid.
     * @deny (update, delete): Update/delete is denied if the teacherId does not match the auth.uid, or if the resource does not exist.
     * @principle Enforces document ownership for all operations.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get, list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (get, list): Owner can read their students.
     * @allow (create): Owner can create their students if the teacherId matches their auth.uid.
     * @allow (update, delete): Owner can update/delete their students if it exists.
     * @deny (create): Creation is denied if the teacherId does not match the auth.uid.
     * @deny (update, delete): Update/delete is denied if the teacherId does not match the auth.uid, or if the resource does not exist.
     * @principle Enforces document ownership for all operations.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get, list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (get, list): Owner can read their training programs.
     * @allow (create): Owner can create their training programs if the teacherId matches their auth.uid.
     * @allow (update, delete): Owner can update/delete their training programs if it exists.
     * @deny (create): Creation is denied if the teacherId does not match the auth.uid.
     * @deny (update, delete): Update/delete is denied if the teacherId does not match the auth.uid, or if the resource does not exist.
     * @principle Enforces document ownership for all operations.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get, list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows teachers to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (get, list): Owner can read their simulations.
     * @allow (create): Owner can create their simulations if the teacherId matches their auth.uid.
     * @allow (update, delete): Owner can update/delete their simulations if it exists.
     * @deny (create): Creation is denied if the teacherId does not match the auth.uid.
     * @deny (update, delete): Update/delete is denied if the teacherId does not match the auth.uid, or if the resource does not exist.
     * @principle Enforces document ownership for all operations.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }
      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get, list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows students to manage their progress.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (get, list): Owner can read their progress.
     * @allow (create): Owner can create their progress if the studentId matches their auth.uid.
     * @allow (update, delete): Owner can update/delete their progress if it exists.
     * @deny (create): Creation is denied if the studentId does not match the auth.uid.
     * @deny (update, delete): Update/delete is denied if the studentId does not match the auth.uid, or if the resource does not exist.
     * @principle Enforces document ownership for all operations.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }
       function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get, list: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }

     /**
      * @description Allows students to store their evaluations.
      * @path /students/{studentId}/storedEvals/{tpId}
      * @allow (get, list): Owner can read their stored evals.
      * @allow (create): Owner can create their stored evals if the studentId matches their auth.uid.
      * @allow (update, delete): Owner can update/delete their stored evals if it exists.
      * @deny (create): Creation is denied if the studentId does not match the auth.uid.
      * @deny (update, delete): Update/delete is denied if the studentId does not match the auth.uid, or if the resource does not exist.
      * @principle Enforces document ownership for all operations.
      */
     match /students/{studentId}/storedEvals/{tpId} {
          function isSignedIn() {
            return request.auth != null;
          }
          function isOwner(studentId) {
            return request.auth.uid == studentId;
          }
           function isExistingOwner(studentId) {
            return isOwner(studentId) && resource != null;
          }

          allow get, list: if isOwner(studentId);
          allow create: if isOwner(studentId);
          allow update: if isExistingOwner(studentId);
          allow delete: if isExistingOwner(studentId);
     }
  }
}