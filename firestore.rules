/**
 * @file Firestore Security Rules for Formula Skills Garage.
 *
 * @core_philosophy This ruleset enforces a strict, path-based ownership model. Teachers can only manage data (students, training programs, simulations) that fall under their designated `/teachers/{teacherId}` path. Students can only manage their progress under `/students/{studentId}`.
 *
 * @data_structure The data is structured hierarchically:
 *   - /teachers/{teacherId}: Teacher profiles (teacherId == auth.uid)
 *   - /teachers/{teacherId}/students/{studentId}: Student profiles managed by a teacher.
 *   - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Training programs created by a teacher.
 *   - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Simulations within a training program.
 *   - /students/{studentId}/studentProgress/{studentProgressId}: Student's progress records.
 *   - /assignedTps/{studentId}: Training programs assigned to a student.
 *
 * @key_security_decisions
 *   - Teachers can only manage data nested under their teacherId.
 *   - Students can only manage data nested under their studentId.
 *   - The `teacherId` field is denormalized into Student and TrainingProgram documents to simplify ownership checks and avoid costly `get()` calls.
 *   - Listing operations are generally allowed for owners of a given path, except where explicitly denied.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a teacher to manage their own profile.
     * @path /teachers/{teacherId}
     * @allow (get, create, update, delete, list) if isSignedIn() && request.auth.uid == teacherId
     * @deny (create, update, delete) if request.auth.uid != teacherId
     * @principle Enforces document ownership for all operations.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      // Read Rules
      allow get: if isSignedIn() && isOwner(teacherId);
      allow list: if false;

      // Write Rules
      allow create: if isSignedIn() && isOwner(teacherId);
      allow update: if isSignedIn() && isExistingOwner(teacherId);
      allow delete: if isSignedIn() && isExistingOwner(teacherId);
    }

    /**
     * @description Allows a teacher to manage students associated with their profile.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (get, list, create) if isSignedIn() && request.auth.uid == teacherId
     * @deny (create, update, delete) if request.auth.uid != teacherId
     * @principle Enforces document ownership for writes, restricts listing to the owner.
     */
    match /teachers/{teacherId}/students/{studentId} {

        function isSignedIn() {
          return request.auth != null;
        }

        function isOwner(teacherId) {
          return request.auth.uid == teacherId;
        }

        function isExistingOwner(teacherId) {
          return isOwner(teacherId) && resource != null;
        }


        // Read Rules
        allow get: if isSignedIn() && isOwner(teacherId);
        allow list: if isSignedIn() && isOwner(teacherId);

        // Write Rules
        allow create: if isSignedIn() && isOwner(teacherId) && request.resource.data.teacherId == teacherId;
        allow update: if isSignedIn() && isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
        allow delete: if isSignedIn() && isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
    }

    /**
     * @description Allows a teacher to manage training programs associated with their profile.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (get, list, create) if isSignedIn() && request.auth.uid == teacherId
     * @deny (create, update, delete) if request.auth.uid != teacherId
     * @principle Enforces document ownership for writes, restricts listing to the owner.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {

      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      // Read Rules
      allow get: if isSignedIn() && isOwner(teacherId);
      allow list: if isSignedIn() && isOwner(teacherId);

      // Write Rules
      allow create: if isSignedIn() && isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isSignedIn() && isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
      allow delete: if isSignedIn() && isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
    }

    /**
     * @description Allows a teacher to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (get, list, create) if isSignedIn() && request.auth.uid == teacherId
     * @deny (create, update, delete) if request.auth.uid != teacherId
     * @principle Enforces document ownership for writes, restricts listing to the owner.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {

      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      // Read Rules
      allow get: if isSignedIn() && isOwner(teacherId);
      allow list: if isSignedIn() && isOwner(teacherId);

      // Write Rules
      allow create: if isSignedIn() && isOwner(teacherId);
      allow update: if isSignedIn() && isExistingOwner(teacherId);
      allow delete: if isSignedIn() && isExistingOwner(teacherId);
    }

    /**
     * @description Allows a student to manage their own progress records.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (get, list, create) if isSignedIn() && request.auth.uid == studentId
     * @deny (create, update, delete) if request.auth.uid != studentId
     * @principle Enforces document ownership for writes, restricts listing to the owner.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {

      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }

       function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      // Read Rules
      allow get: if isSignedIn() && isOwner(studentId);
      allow list: if isSignedIn() && isOwner(studentId);

      // Write Rules
      allow create: if isSignedIn() && isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isSignedIn() && isExistingOwner(studentId) && resource.data.studentId == studentId;
      allow delete: if isSignedIn() && isExistingOwner(studentId) && resource.data.studentId == studentId;
    }

    /**
     * @description Allows access to assigned training programs for a specific student.
     * @path /assignedTps/{studentId}
     * @allow (get, list, create) if isSignedIn() && request.auth.uid == studentId
     * @deny (create, update, delete) if request.auth.uid != studentId
     * @principle Enforces document ownership for writes, restricts listing to the owner.
     */
    match /assignedTps/{studentId} {

      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }

       function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      // Read Rules
      allow get: if isSignedIn() && isOwner(studentId);
      allow list: if false;

      // Write Rules
      allow create: if isSignedIn() && isOwner(studentId);
      allow update: if isSignedIn() && isExistingOwner(studentId);
      allow delete: if isSignedIn() && isExistingOwner(studentId);
    }
     /**
     * @description Allows a student to manage their own final evaluation data for a specific TP.
     * @path /students/{studentId}/storedEvals/{tpId}
     */
    match /students/{studentId}/storedEvals/{tpId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isOwner(studentId) {
          return request.auth.uid == studentId;
        }

         function isExistingOwner(studentId) {
          return isOwner(studentId) && resource != null;
        }

        // Read Rules
        allow get: if isSignedIn() && isOwner(studentId);
        allow list: if isSignedIn() && isOwner(studentId);

        // Write Rules
        allow create: if isSignedIn() && isOwner(studentId);
        allow update: if isSignedIn() && isExistingOwner(studentId);
        allow delete: if isSignedIn() && isExistingOwner(studentId);
    }
  }
}