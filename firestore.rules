/**
 * @fileoverview Firestore Security Rules for Formula Skills Garage.
 *
 * Core Philosophy: This ruleset enforces a strict owner-only access model for
 * user-specific data, with teachers owning students and training programs.
 * Data is segregated under user-specific paths (teachers and students) to
 * leverage path-based authorization.
 *
 * Data Structure:
 * - /teachers/{teacherId}: Teacher profiles (teacherId == auth.uid).
 * - /teachers/{teacherId}/students/{studentId}: Student profiles.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Training programs.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Simulations.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Student progress records.
 * - /students/{studentId}/storedEvals/{tpId}: Stores the final evaluation data for a student on a specific TP.
 *
 * Key Security Decisions:
 * - Teachers can only manage data (students, training programs, simulations) under their own teacherId.
 * - Students can only manage their own progress records and stored evaluations.
 * - Listing of user subcollections is allowed only to the owner.
 * - Data ownership is enforced using path-based rules and denormalized teacherId fields.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the existing owner of the resource.
     *              Also verifies that the resource exists.  Useful for update/delete.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {bool} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces teacher-only access to teacher profiles.
     * @path /teachers/{teacherId}
     * @allow (create) Teacher with matching teacherId can create their profile.
     * @allow (get, list, update, delete) Teacher with matching teacherId can access and manage their profile.
     * @deny (create) Non-teacher attempts to create a profile.
     * @deny (get, list, update, delete) Other teachers or non-authenticated users attempt to access.
     * @principle Enforces document ownership for writes.
     */
    match /teachers/{teacherId} {
      allow get: if isOwner(teacherId);
      allow list: if false;
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Enforces teacher-only access to student profiles under their control.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) Teacher creates a student profile under their teacherId.
     * @allow (get, list, update, delete) Teacher can access and manage students under their teacherId.
     * @deny (create, get, list, update, delete) Other teachers or students attempt to access.
     * @principle Restricts access to a teacher's own data tree.
     */
    match /teachers/{teacherId}/students/{studentId} {
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Enforces teacher-only access to training programs under their control.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) Teacher creates a training program under their teacherId.
     * @allow (get, list, update, delete) Teacher can access and manage training programs under their teacherId.
     * @deny (create, get, list, update, delete) Other teachers or students attempt to access.
     * @principle Restricts access to a teacher's own data tree.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Enforces teacher-only access to simulations under their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) Teacher creates a simulation under their training program.
     * @allow (get, list, update, delete) Teacher can access and manage simulations under their training program.
     * @deny (create, get, list, update, delete) Other teachers or students attempt to access.
     * @principle Restricts access to a teacher's own data tree.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Enforces student-only access to their own progress records.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) Student can create their progress records under their studentId.
     * @allow (get, list, update, delete) Student can access and manage their own progress records.
     * @deny (create, get, list, update, delete) Other students or teachers attempt to access.
     * @principle Restricts access to a student's own data tree.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId) && resource.data.studentId == studentId;
      allow delete: if isExistingOwner(studentId);
    }

        /**
     * @description Enforces student-only access to their own stored evaluations.
     * @path /students/{studentId}/storedEvals/{tpId}
     * @allow (create) Student can create their stored evals under their studentId.
     * @allow (get, list, update, delete) Student can access and manage their own stored evals.
     * @deny (create, get, list, update, delete) Other students or teachers attempt to access.
     */
    match /students/{studentId}/storedEvals/{tpId} {
      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }
  }
}