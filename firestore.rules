/**
 * @fileoverview Firestore Security Rules for Formula Skills Garage application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict ownership model, primarily based on path-based authorization.
 * Teachers can only manage data directly related to them, while students can only access their own progress data.
 *
 * Data Structure:
 * - /teachers/{teacherId}: Teacher profiles, where teacherId is the Firebase auth.uid.
 * - /teachers/{teacherId}/students/{studentId}: Student profiles managed by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Training programs created by a teacher.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Simulations within a training program.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Student progress records.
 *
 * Key Security Decisions:
 * - Teachers can only manage students, training programs, and simulations that belong to them (path-based ownership).
 * - Students can only manage their own progress records (path-based ownership).
 * - No user listing is allowed except for listing students/trainingPrograms/simulations that belong to a teacher (path-based).
 * - Data consistency is enforced by validating the 'teacherId' or 'studentId' on document creation.
 *
 * Denormalization for Authorization:
 * - The 'teacherId' is denormalized into the Student and TrainingProgram documents to allow for efficient authorization checks without requiring additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure teacher profiles. Teachers can only read/write their own profile.
     * @path /teachers/{teacherId}
     * @allow (create) - Teacher with UID 'teacher123' can create their own profile document with teacherId = 'teacher123'.
     * @allow (get) - Teacher with UID 'teacher123' can get their own profile document with teacherId = 'teacher123'.
     * @allow (update) - Teacher with UID 'teacher123' can update their own profile document with teacherId = 'teacher123'.
     * @allow (delete) - Teacher with UID 'teacher123' can delete their own profile document with teacherId = 'teacher123'.
     * @allow (list) - Listing teachers is not allowed.
     * @deny (create) - Teacher with UID 'teacher123' cannot create a profile with teacherId = 'otherTeacher123'.
     * @deny (get) - Teacher with UID 'teacher123' cannot get the profile of another teacher.
     * @deny (update) - Teacher with UID 'teacher123' cannot update the profile of another teacher.
     * @deny (delete) - Teacher with UID 'teacher123' cannot delete the profile of another teacher.
     * @principle Enforces document ownership for writes and restricts access to a user's own data.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if false;
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Secure student profiles under a teacher. Teachers can manage their own students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) - Teacher with UID 'teacher123' can create a student profile under /teachers/teacher123/students/student456.
     * @allow (get) - Teacher with UID 'teacher123' can get a student profile under /teachers/teacher123/students/student456.
     * @allow (update) - Teacher with UID 'teacher123' can update a student profile under /teachers/teacher123/students/student456.
     * @allow (delete) - Teacher with UID 'teacher123' can delete a student profile under /teachers/teacher123/students/student456.
     * @allow (list) - Teacher with UID 'teacher123' can list student profiles under /teachers/teacher123/.
     * @deny (create) - Teacher with UID 'teacher123' cannot create a student profile under /teachers/otherTeacher123/students/student456.
     * @deny (get) - Teacher with UID 'teacher123' cannot get a student profile under /teachers/otherTeacher123/students/student456.
     * @deny (update) - Teacher with UID 'teacher123' cannot update a student profile under /teachers/otherTeacher123/students/student456.
     * @deny (delete) - Teacher with UID 'teacher123' cannot delete a student profile under /teachers/otherTeacher123/students/student456.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Secure training programs under a teacher. Teachers can manage their own training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) - Teacher with UID 'teacher123' can create a training program under /teachers/teacher123/trainingPrograms/tp123.
     * @allow (get) - Teacher with UID 'teacher123' can get a training program under /teachers/teacher123/trainingPrograms/tp123.
     * @allow (update) - Teacher with UID 'teacher123' can update a training program under /teachers/teacher123/trainingPrograms/tp123.
     * @allow (delete) - Teacher with UID 'teacher123' can delete a training program under /teachers/teacher123/trainingPrograms/tp123.
     * @allow (list) - Teacher with UID 'teacher123' can list training programs under /teachers/teacher123/.
     * @deny (create) - Teacher with UID 'teacher123' cannot create a training program under /teachers/otherTeacher123/trainingPrograms/tp123.
     * @deny (get) - Teacher with UID 'teacher123' cannot get a training program under /teachers/otherTeacher123/trainingPrograms/tp123.
     * @deny (update) - Teacher with UID 'teacher123' cannot update a training program under /teachers/otherTeacher123/trainingPrograms/tp123.
     * @deny (delete) - Teacher with UID 'teacher123' cannot delete a training program under /teachers/otherTeacher123/trainingPrograms/tp123.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Secure simulations under a training program. Teachers can manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) - Teacher with UID 'teacher123' can create a simulation under /teachers/teacher123/trainingPrograms/tp123/simulations/sim123.
     * @allow (get) - Teacher with UID 'teacher123' can get a simulation under /teachers/teacher123/trainingPrograms/tp123/simulations/sim123.
     * @allow (update) - Teacher with UID 'teacher123' can update a simulation under /teachers/teacher123/trainingPrograms/tp123/simulations/sim123.
     * @allow (delete) - Teacher with UID 'teacher123' can delete a simulation under /teachers/teacher123/trainingPrograms/tp123/simulations/sim123.
     * @allow (list) - Teacher with UID 'teacher123' can list simulations under /teachers/teacher123/trainingPrograms/tp123/.
     * @deny (create) - Teacher with UID 'teacher123' cannot create a simulation under /teachers/otherTeacher123/trainingPrograms/tp123/simulations/sim123.
     * @deny (get) - Teacher with UID 'teacher123' cannot get a simulation under /teachers/otherTeacher123/trainingPrograms/tp123/simulations/sim123.
     * @deny (update) - Teacher with UID 'teacher123' cannot update a simulation under /teachers/otherTeacher123/trainingPrograms/tp123/simulations/sim123.
     * @deny (delete) - Teacher with UID 'teacher123' cannot delete a simulation under /teachers/otherTeacher123/trainingPrograms/tp123/simulations/sim123.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Secure student progress records. Students can only manage their own progress.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) - Student with UID 'student123' can create their own progress record under /students/student123/studentProgress/sp123.
     * @allow (get) - Student with UID 'student123' can get their own progress record under /students/student123/studentProgress/sp123.
     * @allow (update) - Student with UID 'student123' can update their own progress record under /students/student123/studentProgress/sp123.
     * @allow (delete) - Student with UID 'student123' can delete their own progress record under /students/student123/studentProgress/sp123.
     * @allow (list) - Student with UID 'student123' can list their own progress records under /students/student123/.
     * @deny (create) - Student with UID 'student123' cannot create a progress record under /students/otherStudent123/studentProgress/sp123.
     * @deny (get) - Student with UID 'student123' cannot get a progress record under /students/otherStudent123/studentProgress/sp123.
     * @deny (update) - Student with UID 'student123' cannot update a progress record under /students/otherStudent123/studentProgress/sp123.
     * @deny (delete) - Student with UID 'student123' cannot delete a progress record under /students/otherStudent123/studentProgress/sp123.
     * @principle Enforces document ownership for writes and restricts access to a user's own data.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }

     /**
      * @description  Deny all access to the root `/tps` collection.
      * @path /tps
      * @allow (get) - Fails, `get` operations are always denied.
      * @allow (list) - Fails, `list` operations are always denied.
      * @allow (create) - Fails, `create` operations are always denied.
      * @allow (update) - Fails, `update` operations are always denied.
      * @allow (delete) - Fails, `delete` operations are always denied.
      * @deny (get) - Any user cannot `get` documents.
      * @deny (list) - Any user cannot `list` documents.
      * @deny (create) - Any user cannot `create` documents.
      * @deny (update) - Any user cannot `update` documents.
      * @deny (delete) - Any user cannot `delete` documents.
      * @principle Explicitly deny access to a collection to prevent unintended access.
      */
    match /tps {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}