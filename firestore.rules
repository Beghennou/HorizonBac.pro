/**
 * @file Firebase Security Rules for Formula Skills Garage.
 *
 * @corePhilosophy This ruleset enforces a strict ownership model based on the Firebase Authentication UID.
 * Teachers can only manage data related to their own profiles (teachers collection) and their associated students, training programs, and simulations.
 * Students can only access their own progress data.
 *
 * @dataStructure The data is organized hierarchically:
 *   - /teachers/{teacherId}: Teacher profiles (teacherId matches auth.uid).
 *   - /teachers/{teacherId}/students/{studentId}: Students managed by a teacher.
 *   - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Training programs created by a teacher.
 *   - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Simulations associated with a training program.
 *   - /students/{studentId}/studentProgress/{studentProgressId}: Student progress records.
 *
 * @keySecurityDecisions
 *   - Teachers can only manage data where the teacherId matches their auth.uid.
 *   - Students can only manage data where the studentId matches their auth.uid.
 *   - Listing of teachers is not allowed to prevent unauthorized access to teacher data.
 *   - Denormalization of teacherId in student and training program documents simplifies ownership checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages teacher profiles. Only authenticated teachers can create their own profile.
     * @path /teachers/{teacherId}
     * @allow (create) - Authenticated user with UID matching the teacherId can create a profile.
     *   Request: auth.uid = "teacher123", path = "/teachers/teacher123"
     * @allow (get, update, delete) - Authenticated teacher with UID matching the teacherId can get, update, or delete their profile.
     *   Request: auth.uid = "teacher123", path = "/teachers/teacher123"
     * @deny (create) - Authenticated user attempts to create a teacher profile with an ID that does not match their UID.
     *   Request: auth.uid = "teacher456", path = "/teachers/teacher123"
     * @deny (update, delete) - Unauthenticated user attempts to modify a teacher profile.
     *   Request: auth.uid = null, path = "/teachers/teacher123"
     * @deny (list) - Listing teachers is disallowed.
     * @principle Enforces document ownership for writes and prevents unauthorized data access.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if false;
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Manages students associated with a teacher. Teachers can create, read, update, and delete students associated with their teacherId.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) - Authenticated teacher creates a student with a matching teacherId.
     *   Request: auth.uid = "teacher123", path = "/teachers/teacher123/students/student456", request.resource.data.teacherId = "teacher123"
     * @allow (get, update, delete) - Authenticated teacher modifies a student with a matching teacherId.
     *   Request: auth.uid = "teacher123", path = "/teachers/teacher123/students/student456", resource.data.teacherId = "teacher123"
     * @deny (create) - Authenticated teacher creates a student with a non-matching teacherId.
     *   Request: auth.uid = "teacher123", path = "/teachers/teacher123/students/student456", request.resource.data.teacherId = "teacher789"
     * @deny (update, delete) - Unauthenticated user attempts to modify a student.
     *   Request: auth.uid = null, path = "/teachers/teacher123/students/student456"
     * @principle Enforces document ownership for writes, validates relational integrity (teacher-student), and prevents unauthorized data access.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Manages training programs created by a teacher. Teachers can create, read, update, and delete training programs associated with their teacherId.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) - Authenticated teacher creates a training program with a matching teacherId.
     *   Request: auth.uid = "teacher123", path = "/teachers/teacher123/trainingPrograms/tp456", request.resource.data.teacherId = "teacher123"
     * @allow (get, update, delete) - Authenticated teacher modifies a training program with a matching teacherId.
     *   Request: auth.uid = "teacher123", path = "/teachers/teacher123/trainingPrograms/tp456", resource.data.teacherId = "teacher123"
     * @deny (create) - Authenticated teacher creates a training program with a non-matching teacherId.
     *   Request: auth.uid = "teacher123", path = "/teachers/teacher123/trainingPrograms/tp456", request.resource.data.teacherId = "teacher789"
     * @deny (update, delete) - Unauthenticated user attempts to modify a training program.
     *   Request: auth.uid = null, path = "/teachers/teacher123/trainingPrograms/tp456"
     * @principle Enforces document ownership for writes, validates relational integrity (teacher-trainingProgram), and prevents unauthorized data access.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Manages simulations associated with a training program. Teachers can create, read, update, and delete simulations under their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) - Authenticated teacher creates a simulation under their training program.
     *   Request: auth.uid = "teacher123", path = "/teachers/teacher123/trainingPrograms/tp456/simulations/sim789"
     * @allow (get, update, delete) - Authenticated teacher modifies a simulation under their training program.
     *   Request: auth.uid = "teacher123", path = "/teachers/teacher123/trainingPrograms/tp456/simulations/sim789"
     * @deny (create) - Unauthenticated user attempts to create a simulation.
     *   Request: auth.uid = null, path = "/teachers/teacher123/trainingPrograms/tp456/simulations/sim789"
     * @deny (update, delete) - Unauthenticated user attempts to modify a simulation.
     *   Request: auth.uid = null, path = "/teachers/teacher123/trainingPrograms/tp456/simulations/sim789"
     * @principle Enforces document ownership for writes and prevents unauthorized data access.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

       function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Manages student progress data. Students can read, create, update, and delete their own progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) - Authenticated user creates progress data for their own studentId.
     *   Request: auth.uid = "student123", path = "/students/student123/studentProgress/progress456"
     * @allow (get, update, delete) - Authenticated user modifies progress data for their own studentId.
     *   Request: auth.uid = "student123", path = "/students/student123/studentProgress/progress456"
     * @deny (create) - Authenticated user attempts to create progress data for another studentId.
     *   Request: auth.uid = "student456", path = "/students/student123/studentProgress/progress456"
     * @deny (update, delete) - Unauthenticated user attempts to modify student progress data.
     *   Request: auth.uid = null, path = "/students/student123/studentProgress/progress456"
     * @principle Enforces document ownership for writes and prevents unauthorized data access.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }

       function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }
  }
}