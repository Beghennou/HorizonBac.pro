/**
 * @file Firestore Security Rules for Formula Skills Garage.
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for teachers and students,
 *                  ensuring that only the authenticated user (teacher or student) can access
 *                  and modify their own data, or data explicitly shared with them.
 *                  Data consistency is validated on create and update operations to ensure
 *                  relational integrity, with denormalization of key relationships for
 *                  efficient authorization.
 *
 * @data_structure
 *  - /teachers/{teacherId}: Stores teacher profiles. teacherId MUST match auth.uid.
 *  - /teachers/{teacherId}/students/{studentId}: Stores student profiles managed by a teacher.
 *  - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Stores training programs created by a teacher.
 *  - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Stores simulation data for training programs.
 *  - /students/{studentId}/studentProgress/{studentProgressId}: Stores student progress records.
 *
 * @key_security_decisions
 *  - Teacher and student data is strictly segregated. Teachers can only access their own students and training programs.
 *  - Students can only access their own progress data.
 *  - Denormalization is used to avoid costly `get()` calls.
 *  - Schema validation is relaxed during this prototyping phase to allow rapid iteration, except for key
 *    fields required for authorization (e.g., teacherId, studentId).
 *  - List operations are restricted to the owner of the data, unless explicitly allowed.
 *
 * @denormalization_for_authorization
 *  - The 'teacherId' is denormalized into the Student and TrainingProgram documents to enable
 *    direct authorization checks without additional reads.
 *
 * @structural_segregation  N/A - No public data is served from Firestore.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a teacher to manage their own profile.
     * @path /teachers/{teacherId}
     * @allow (create) If the user is authenticated and the teacherId matches their auth.uid.
     * @allow (get, update, delete) If the user is authenticated and the teacherId matches their auth.uid.
     * @deny (create) If the user is not authenticated.
     * @deny (update, delete) If the teacher document does not exist.
     * @deny (create, update, delete) If the teacherId does not match the auth.uid.
     * @principle Enforces document ownership and verified identity.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
          return isOwner(teacherId) && resource != null;
      }

      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn() && isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows a teacher to manage their students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create, get, list, update, delete) If the user is authenticated and the teacherId matches their auth.uid.
     * @deny (create, update, delete) If the student's teacherId does not match the path.
     * @deny (create, update, delete) If the teacherId does not match the auth.uid.
     * @principle Enforces document ownership and data consistency.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }

        function isExistingOwner(teacherId) {
          return isOwner(teacherId) && resource != null;
      }

      allow get: if isSignedIn() && isOwner(teacherId);
      allow list: if isSignedIn() && isOwner(teacherId);
      allow create: if isSignedIn() && isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == teacherId && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
    }

    /**
     * @description Allows a teacher to manage their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create, get, list, update, delete) If the user is authenticated and the teacherId matches their auth.uid.
     * @deny (create, update, delete) If the training program's teacherId does not match the path.
     * @deny (create, update, delete) If the teacherId does not match the auth.uid.
     * @principle Enforces document ownership and data consistency.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }

        function isExistingOwner(teacherId) {
          return isOwner(teacherId) && resource != null;
      }

      allow get: if isSignedIn() && isOwner(teacherId);
      allow list: if isSignedIn() && isOwner(teacherId);
      allow create: if isSignedIn() && isOwner(teacherId) && request.resource.data.teacherId == teacherId;
      allow update: if isExistingOwner(teacherId) && request.resource.data.teacherId == teacherId && request.resource.data.teacherId == resource.data.teacherId;
      allow delete: if isExistingOwner(teacherId) && resource.data.teacherId == teacherId;
    }

    /**
     * @description Allows a teacher to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create, get, list, update, delete) If the user is authenticated and the teacherId matches their auth.uid.
     * @deny (create, update, delete) If the teacherId does not match the auth.uid.
     * @principle Enforces document ownership.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return request.auth.uid == teacherId;
      }

        function isExistingOwner(teacherId) {
          return isOwner(teacherId) && resource != null;
      }

      allow get: if isSignedIn() && isOwner(teacherId);
      allow list: if isSignedIn() && isOwner(teacherId);
      allow create: if isSignedIn() && isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows a student to manage their own progress.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create, get, list, update, delete) If the user is authenticated and the studentId matches their auth.uid.
     * @deny (create, update, delete) If the studentId does not match the auth.uid.
     * @principle Enforces document ownership.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }

        function isExistingOwner(studentId) {
          return isOwner(studentId) && resource != null;
      }

      allow get: if isSignedIn() && isOwner(studentId);
      allow list: if isSignedIn() && isOwner(studentId);
      allow create: if isSignedIn() && isOwner(studentId) && request.resource.data.studentId == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.studentId == studentId && request.resource.data.studentId == resource.data.studentId;
      allow delete: if isExistingOwner(studentId) && resource.data.studentId == studentId;
    }
  }
}