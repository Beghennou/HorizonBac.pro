/**
 * @fileoverview Firestore Security Rules for the Formula Skills Garage application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model, ensuring that teachers can only
 * access and modify data related to their own students and training programs. Students
 * can only access their own progress data. Data consistency is enforced by validating
 * the 'teacherId' or 'studentId' against the path in create operations and enforcing
 * immutability of these fields on update.
 *
 * Data Structure:
 * - /teachers/{teacherId}: Stores teacher profiles. The teacherId MUST match the Firebase auth.uid.
 * - /teachers/{teacherId}/students/{studentId}: Stores student profiles. Includes denormalized 'teacherId' for authorization independence.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}: Stores training programs created by teachers. Includes denormalized 'teacherId' for authorization independence.
 * - /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}: Stores simulation data associated with training programs.
 * - /students/{studentId}/studentProgress/{studentProgressId}: Stores student progress data.
 * - /students/{studentId}/storedEvals/{tpId}: Stores the final evaluation data for a student on a specific TP.
 *
 * Key Security Decisions:
 * - Teachers can only manage students and training programs that they own (teacherId matches auth.uid).
 * - Students can only access their own progress data (studentId matches auth.uid).
 * - Listing of all training programs at the root collection is disallowed.
 * - Ownership is enforced through path-based matching and denormalized teacherId/studentId fields.
 * - Relational integrity (teacher-student, teacher-training program) is validated on creation and updates.
 * - Strict immutability of owner ID is enforced for added security.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a teacher to manage their own profile.
     * @path /teachers/{teacherId}
     * @allow (create) Teacher with teacherId matching auth.uid can create their profile.
     * @allow (get, update, delete) Teacher with teacherId matching auth.uid can read, update, and delete their profile.
     * @deny (create) Teacher with teacherId NOT matching auth.uid cannot create a profile.
     * @deny (update, delete) Another teacher attempts to modify a teacher's profile.
     * @principle Enforces document ownership and verified identity for teacher profiles.
     */
    match /teachers/{teacherId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if true; // Public get allowed

      allow list: if false;

      allow create: if isOwner(teacherId);

      allow update: if isExistingOwner(teacherId);

      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows a teacher to manage their own students.
     * @path /teachers/{teacherId}/students/{studentId}
     * @allow (create) Teacher can create a student with teacherId matching auth.uid.
     * @allow (get, list, update, delete) Teacher can read, list, update, and delete their own students.
     * @deny (create) Teacher attempts to create a student with mismatched teacherId.
     * @deny (update, delete) Another teacher attempts to modify a student.
     * @principle Enforces document ownership and relational integrity between teachers and students.
     */
    match /teachers/{teacherId}/students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if true;

      allow list: if isOwner(teacherId);

      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;

      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == request.resource.data.teacherId;

      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows a teacher to manage their own training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}
     * @allow (create) Teacher can create a training program with teacherId matching auth.uid.
     * @allow (get, list, update, delete) Teacher can read, list, update, and delete their own training programs.
     * @deny (create) Teacher attempts to create a training program with mismatched teacherId.
     * @deny (update, delete) Another teacher attempts to modify a training program.
     * @principle Enforces document ownership and relational integrity for training programs.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if true;

      allow list: if isOwner(teacherId);

      allow create: if isOwner(teacherId) && request.resource.data.teacherId == teacherId;

      allow update: if isExistingOwner(teacherId) && resource.data.teacherId == request.resource.data.teacherId;

      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows a teacher to manage simulations within their training programs.
     * @path /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId}
     * @allow (create) Teacher can create a simulation under their training program.
     * @allow (get, list, update, delete) Teacher can read, list, update, and delete simulations within their training program.
     * @deny (create) Teacher attempts to create a simulation with mismatched teacherId or trainingProgramId.
     * @deny (update, delete) Another teacher attempts to modify a simulation.
     * @principle Enforces nested document ownership and relational integrity for simulations.
     */
    match /teachers/{teacherId}/trainingPrograms/{trainingProgramId}/simulations/{simulationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if true;

      allow list: if isOwner(teacherId);

      allow create: if isOwner(teacherId);

      allow update: if isExistingOwner(teacherId);

      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Allows a student to manage their own progress data.
     * @path /students/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) Student can create their own progress data.
     * @allow (get, list, update, delete) Student can read, list, update, and delete their own progress data.
     * @deny (create) Student attempts to create progress data with mismatched studentId.
     * @deny (update, delete) Another student attempts to modify a student's progress.
     * @principle Enforces document ownership and data consistency for student progress.
     */
    match /students/{studentId}/studentProgress/{studentProgressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);

      allow list: if isOwner(studentId);

      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;

      allow update: if isExistingOwner(studentId) && resource.data.studentId == request.resource.data.studentId;

      allow delete: if isExistingOwner(studentId);
    }
    
    /**
     * @description Allows a student to manage their stored evaluations data.
     * @path /students/{studentId}/storedEvals/{tpId}
     * @allow (create) Student can create their own eval data.
     * @allow (get, list, update, delete) Student can read, list, update, and delete their own eval data.
     * @deny (create) Student attempts to create eval data with mismatched studentId.
     * @deny (update, delete) Another student attempts to modify a student's evals.
     * @principle Enforces document ownership and data consistency for student progress.
     */
    match /students/{studentId}/storedEvals/{tpId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);

      allow list: if isOwner(studentId);

      allow create: if isOwner(studentId) && request.resource.data.studentId == studentId;

      allow update: if isExistingOwner(studentId) && resource.data.studentId == request.resource.data.studentId;

      allow delete: if isExistingOwner(studentId);
    }

     /**
      * @description Disallows listing of training programs at the root level.  The request reported an error in `src/firebase/firestore/use-collection.tsx` at path `tps` during a `list` operation.  This implies the code is attempting to directly read from the root `/tps` collection.  We deny this to enforce owner based access only from within teacher records.
      * @path /tps
      * @deny (list) Any user attempting to list training programs at the root level.
      * @principle Enforces that training programs must only be accessed from within a teacher's record.
      */
    match /tps {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}